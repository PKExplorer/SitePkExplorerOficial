<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>PK Explorer ‚Äî Pontos Geohist√≥ricos</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.css">
<link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@700;900&family=DM+Sans:wght@300;400;500&display=swap" rel="stylesheet">
<style>
  :root{--ink:#1a1208;--parchment:#f5edd6;--sepia:#c4933a;--rust:#b5451b;--moss:#3d6b4f;--cream:#faf4e8;--shadow:rgba(26,18,8,0.18);}
  *{margin:0;padding:0;box-sizing:border-box;}
  body{font-family:'DM Sans',sans-serif;background:var(--cream);color:var(--ink);min-height:100vh;overflow-x:hidden;}
  header{background:var(--ink);padding:0 24px;display:flex;align-items:center;justify-content:space-between;height:64px;position:fixed;top:0;left:0;right:0;z-index:1000;box-shadow:0 2px 20px rgba(0,0,0,0.4);}
  .logo{font-family:'Playfair Display',serif;font-size:1.4rem;font-weight:900;color:var(--sepia);}
  .logo span{color:var(--parchment);font-weight:700;}
  .header-right{display:flex;align-items:center;gap:12px;}
  .status-dot{width:8px;height:8px;border-radius:50%;background:#4caf50;box-shadow:0 0 8px #4caf50;animation:pulse-dot 2s infinite;}
  @keyframes pulse-dot{0%,100%{opacity:1}50%{opacity:0.4}}
  .status-label{font-size:0.75rem;color:rgba(255,255,255,0.5);font-weight:300;}
  .app{padding-top:64px;display:grid;grid-template-columns:420px 1fr;height:100vh;}
  .sidebar{background:var(--parchment);border-right:1px solid rgba(196,147,58,0.3);display:flex;flex-direction:column;overflow:hidden;position:relative;}
  .sidebar::before{content:'';position:absolute;top:0;left:0;right:0;height:3px;background:linear-gradient(90deg,var(--sepia),var(--rust),var(--moss));}
  .sidebar-tabs{display:flex;border-bottom:1px solid rgba(196,147,58,0.2);}
  .tab-btn{flex:1;padding:13px 4px;font-family:'DM Sans',sans-serif;font-size:0.72rem;font-weight:500;background:none;border:none;cursor:pointer;color:rgba(26,18,8,0.45);border-bottom:2px solid transparent;transition:all 0.2s;margin-bottom:-1px;white-space:nowrap;}
  .tab-btn.active{color:var(--rust);border-bottom-color:var(--rust);}
  .tab-panel{display:none;flex:1;overflow-y:auto;}
  .tab-panel.active{display:flex;flex-direction:column;}
  .form-area{padding:18px 22px;}
  .form-group{margin-bottom:13px;}
  label{display:block;font-size:0.7rem;font-weight:500;text-transform:uppercase;letter-spacing:0.08em;color:rgba(26,18,8,0.5);margin-bottom:5px;}
  input,textarea,select{width:100%;background:white;border:1.5px solid rgba(196,147,58,0.3);border-radius:8px;padding:9px 13px;font-family:'DM Sans',sans-serif;font-size:0.87rem;color:var(--ink);transition:border-color 0.2s,box-shadow 0.2s;outline:none;}
  input:focus,textarea:focus,select:focus{border-color:var(--sepia);box-shadow:0 0 0 3px rgba(196,147,58,0.15);}
  textarea{resize:vertical;min-height:70px;line-height:1.5;}
  select{appearance:none;background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='8' viewBox='0 0 12 8'%3E%3Cpath d='M1 1l5 5 5-5' stroke='%23c4933a' fill='none' stroke-width='2'/%3E%3C/svg%3E");background-repeat:no-repeat;background-position:right 13px center;cursor:pointer;}
  .gps-row{display:grid;grid-template-columns:1fr 1fr;gap:8px;}
  .gps-btn{grid-column:1/-1;display:flex;align-items:center;justify-content:center;gap:8px;background:var(--moss);color:white;border:none;border-radius:8px;padding:10px 14px;font-family:'DM Sans',sans-serif;font-size:0.82rem;font-weight:500;cursor:pointer;transition:background 0.2s;}
  .gps-btn:hover{background:#2f5340;}

  /* M√çDIA ‚Äî bot√µes vis√≠veis como chips */
  .media-chips{display:flex;gap:8px;flex-wrap:wrap;margin-bottom:10px;}
  .media-chip{display:flex;align-items:center;gap:6px;padding:8px 16px;border-radius:24px;border:2px solid rgba(196,147,58,0.35);background:white;font-family:'DM Sans',sans-serif;font-size:0.82rem;font-weight:500;cursor:pointer;color:rgba(26,18,8,0.6);transition:all 0.2s;user-select:none;}
  .media-chip:hover{border-color:var(--sepia);color:var(--sepia);background:rgba(196,147,58,0.05);}
  .media-chip.active{background:var(--sepia);border-color:var(--sepia);color:white;box-shadow:0 2px 8px rgba(196,147,58,0.35);}
  .media-chip-icon{font-size:1rem;}
  .media-panel{display:none;border:2px dashed rgba(196,147,58,0.35);border-radius:10px;padding:14px;background:white;margin-bottom:8px;}
  .media-panel.open{display:block;}
  .upload-zone{text-align:center;cursor:pointer;padding:8px;}
  .upload-zone:hover{background:rgba(196,147,58,0.04);border-radius:8px;}
  .upload-zone-icon{font-size:2rem;display:block;margin-bottom:6px;}
  .upload-zone p{font-size:0.76rem;color:rgba(26,18,8,0.45);}
  .upload-zone input[type=file]{display:none;}
  .upload-btn{display:inline-flex;align-items:center;gap:6px;padding:9px 18px;background:var(--sepia);color:white;border:none;border-radius:8px;font-family:'DM Sans',sans-serif;font-size:0.82rem;font-weight:500;cursor:pointer;transition:background 0.2s;margin-top:8px;}
  .upload-btn:hover{background:#a87c2e;}
  .media-preview{display:flex;flex-wrap:wrap;gap:8px;margin-top:10px;}
  .media-thumb{position:relative;width:68px;height:68px;border-radius:8px;overflow:hidden;border:1.5px solid rgba(196,147,58,0.3);background:#f0e8d0;}
  .media-thumb img,.media-thumb video{width:100%;height:100%;object-fit:cover;}
  .media-thumb .remove-btn{position:absolute;top:2px;right:2px;width:18px;height:18px;border-radius:50%;background:rgba(181,69,27,0.9);color:white;border:none;cursor:pointer;font-size:10px;display:flex;align-items:center;justify-content:center;}

  /* √ÅUDIO */
  .audio-recorder{padding:4px 0;}
  .recorder-controls{display:flex;align-items:center;gap:10px;flex-wrap:wrap;margin-bottom:10px;}
  .rec-btn{display:flex;align-items:center;gap:6px;padding:9px 16px;border-radius:20px;border:none;font-family:'DM Sans',sans-serif;font-size:0.82rem;font-weight:500;cursor:pointer;transition:all 0.2s;}
  .rec-btn.record{background:#ef4444;color:white;}
  .rec-btn.stop{background:#6b7280;color:white;}
  .rec-btn:disabled{opacity:0.4;cursor:not-allowed;}
  .rec-timer{font-size:0.82rem;font-weight:500;font-variant-numeric:tabular-nums;}
  .rec-dot{width:8px;height:8px;border-radius:50%;background:#ef4444;animation:pulse-dot 1s infinite;}
  .audio-list{display:flex;flex-direction:column;gap:6px;}
  .audio-item{display:flex;align-items:center;gap:8px;padding:8px 12px;background:rgba(196,147,58,0.08);border-radius:8px;border:1px solid rgba(196,147,58,0.2);}
  .audio-item audio{flex:1;height:32px;}
  .audio-item .remove-btn{width:22px;height:22px;border-radius:50%;background:var(--rust);color:white;border:none;cursor:pointer;font-size:11px;display:flex;align-items:center;justify-content:center;flex-shrink:0;}

  .submit-btn{width:100%;background:var(--rust);color:white;border:none;border-radius:8px;padding:13px;font-family:'Playfair Display',serif;font-size:1rem;font-weight:700;cursor:pointer;transition:background 0.2s,box-shadow 0.2s;letter-spacing:0.02em;margin-top:4px;}
  .submit-btn:hover{background:#963c17;box-shadow:0 4px 16px rgba(181,69,27,0.35);}
  .submit-btn:disabled{background:#ccc;cursor:not-allowed;box-shadow:none;}

  /* LISTA PONTOS */
  .points-list-area{flex:1;overflow-y:auto;padding:16px 22px;}
  .list-header{font-family:'Playfair Display',serif;font-size:1rem;font-weight:700;margin-bottom:12px;display:flex;align-items:center;gap:8px;}
  .count-badge{background:var(--sepia);color:white;font-family:'DM Sans',sans-serif;font-size:0.72rem;font-weight:500;padding:2px 8px;border-radius:20px;}
  .point-card{background:white;border-radius:10px;padding:12px 14px;margin-bottom:8px;border-left:3px solid var(--moss);box-shadow:0 2px 8px var(--shadow);cursor:pointer;transition:transform 0.15s,box-shadow 0.15s;animation:slide-in 0.3s ease;}
  @keyframes slide-in{from{opacity:0;transform:translateY(-8px)}to{opacity:1;transform:translateY(0)}}
  .point-card:hover{transform:translateX(3px);box-shadow:0 4px 16px var(--shadow);}
  .point-title{font-weight:500;font-size:0.88rem;margin-bottom:4px;}
  .point-meta{font-size:0.73rem;color:rgba(26,18,8,0.5);display:flex;gap:8px;align-items:center;flex-wrap:wrap;}
  .category-tag{background:rgba(196,147,58,0.15);color:var(--sepia);font-size:0.66rem;font-weight:500;padding:2px 7px;border-radius:20px;text-transform:uppercase;letter-spacing:0.05em;}
  .point-media-icons{display:flex;gap:4px;margin-top:4px;}
  .media-icon-badge{font-size:0.68rem;background:rgba(26,18,8,0.07);padding:1px 6px;border-radius:10px;}

  /* ALUNOS */
  .students-area{padding:18px 22px;display:flex;flex-direction:column;gap:14px;flex:1;overflow-y:auto;}
  .students-header{display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;gap:8px;}
  .students-title{font-family:'Playfair Display',serif;font-size:1.05rem;font-weight:700;}
  .students-actions{display:flex;gap:8px;}
  .btn-sm{display:flex;align-items:center;gap:5px;padding:7px 12px;border-radius:8px;border:none;font-family:'DM Sans',sans-serif;font-size:0.76rem;font-weight:500;cursor:pointer;transition:all 0.2s;}
  .btn-sm.primary{background:var(--rust);color:white;}
  .btn-sm.primary:hover{background:#963c17;}
  .btn-sm.secondary{background:var(--moss);color:white;}
  .btn-sm.secondary:hover{background:#2f5340;}
  .btn-sm.outline{background:white;color:var(--sepia);border:1.5px solid rgba(196,147,58,0.4);}
  .btn-sm.outline:hover{background:rgba(196,147,58,0.08);}
  .btn-sm:disabled{opacity:0.4;cursor:not-allowed;}
  .report-stats{display:grid;grid-template-columns:repeat(3,1fr);gap:8px;}
  .stat-box{background:white;border-radius:10px;padding:12px;text-align:center;border:1.5px solid rgba(196,147,58,0.2);}
  .stat-num{font-family:'Playfair Display',serif;font-size:1.5rem;font-weight:700;color:var(--rust);}
  .stat-lbl{font-size:0.66rem;color:rgba(26,18,8,0.45);text-transform:uppercase;letter-spacing:0.05em;}
  .limit-banner{background:rgba(181,69,27,0.08);border:1.5px solid rgba(181,69,27,0.25);border-radius:10px;padding:10px 14px;font-size:0.8rem;color:var(--rust);text-align:center;font-weight:500;}
  .add-student-form{background:white;border-radius:10px;padding:14px;border:1.5px solid rgba(196,147,58,0.25);display:none;}
  .add-student-form.open{display:block;}
  .add-student-row{display:grid;grid-template-columns:1fr 1fr;gap:8px;}
  .add-student-row .full{grid-column:1/-1;}
  .student-list-wrap{display:flex;flex-direction:column;gap:6px;}
  .student-card{background:white;border-radius:10px;padding:11px 14px;border:1.5px solid rgba(196,147,58,0.2);display:flex;align-items:center;gap:10px;transition:box-shadow 0.15s;}
  .student-card:hover{box-shadow:0 2px 12px var(--shadow);}
  .student-avatar{width:36px;height:36px;border-radius:50%;background:linear-gradient(135deg,var(--sepia),var(--rust));display:flex;align-items:center;justify-content:center;color:white;font-weight:700;font-size:0.82rem;flex-shrink:0;}
  .student-info{flex:1;min-width:0;}
  .student-name{font-weight:500;font-size:0.86rem;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
  .student-sub{font-size:0.71rem;color:rgba(26,18,8,0.45);}
  .student-pts{background:var(--sepia);color:white;font-size:0.72rem;font-weight:700;padding:3px 8px;border-radius:20px;flex-shrink:0;}
  .student-pts.zero{background:rgba(26,18,8,0.1);color:rgba(26,18,8,0.4);}
  .student-del{width:24px;height:24px;border-radius:50%;background:rgba(181,69,27,0.1);border:none;cursor:pointer;color:var(--rust);font-size:13px;display:flex;align-items:center;justify-content:center;flex-shrink:0;transition:background 0.15s;}
  .student-del:hover{background:rgba(181,69,27,0.2);}
  .ranking-section{background:white;border-radius:10px;padding:14px;border:1.5px solid rgba(196,147,58,0.2);}
  .section-label{font-size:0.7rem;font-weight:500;text-transform:uppercase;letter-spacing:0.08em;color:rgba(26,18,8,0.45);margin-bottom:10px;}
  .ranking-row{display:flex;align-items:center;gap:10px;padding:6px 0;border-bottom:1px solid rgba(196,147,58,0.1);}
  .ranking-row:last-child{border-bottom:none;}
  .r-pos{font-size:0.78rem;font-weight:700;width:20px;color:var(--sepia);}
  .r-name{flex:1;font-size:0.84rem;font-weight:500;}
  .r-bar-wrap{width:70px;background:rgba(196,147,58,0.12);border-radius:20px;height:6px;overflow:hidden;}
  .r-bar{height:100%;background:linear-gradient(90deg,var(--sepia),var(--rust));border-radius:20px;transition:width 0.6s ease;}
  .r-count{font-size:0.78rem;font-weight:700;color:var(--rust);width:22px;text-align:right;}

  /* MAPA */
  #map{width:100%;height:100%;z-index:1;}

  /* MODAL */
  .modal-overlay{position:fixed;inset:0;background:rgba(0,0,0,0.7);z-index:3000;display:none;align-items:center;justify-content:center;padding:20px;}
  .modal-overlay.open{display:flex;}
  .modal{background:white;border-radius:16px;max-width:580px;width:100%;max-height:90vh;overflow-y:auto;box-shadow:0 20px 60px rgba(0,0,0,0.4);animation:modal-in 0.25s ease;}
  @keyframes modal-in{from{opacity:0;transform:scale(0.94)}to{opacity:1;transform:scale(1)}}
  .modal-header{padding:20px 24px 0;display:flex;justify-content:space-between;align-items:flex-start;}
  .modal-title{font-family:'Playfair Display',serif;font-size:1.2rem;font-weight:700;}
  .modal-cat{font-size:0.75rem;color:var(--sepia);font-weight:500;text-transform:uppercase;letter-spacing:0.06em;margin-top:3px;}
  .modal-close{background:none;border:none;cursor:pointer;color:rgba(26,18,8,0.4);font-size:1.5rem;line-height:1;padding:4px;}
  .modal-body{padding:16px 24px 24px;}
  .modal-meta{background:rgba(196,147,58,0.07);border-radius:10px;padding:12px 14px;margin-bottom:16px;display:flex;flex-wrap:wrap;gap:10px;}
  .modal-meta-item{font-size:0.8rem;color:rgba(26,18,8,0.65);}
  .modal-meta-item strong{color:var(--ink);}
  .modal-desc{font-size:0.9rem;line-height:1.6;color:rgba(26,18,8,0.75);margin-bottom:16px;}
  .modal-media-section{margin-bottom:14px;}
  .modal-media-label{font-size:0.72rem;font-weight:500;text-transform:uppercase;letter-spacing:0.07em;color:rgba(26,18,8,0.45);margin-bottom:8px;}
  .modal-photos{display:grid;grid-template-columns:repeat(auto-fill,minmax(120px,1fr));gap:8px;}
  .modal-photo{width:100%;aspect-ratio:1;object-fit:cover;border-radius:8px;cursor:pointer;transition:transform 0.15s;}
  .modal-photo:hover{transform:scale(1.03);}
  .modal-video{width:100%;border-radius:10px;margin-bottom:8px;}
  .modal-audio{width:100%;margin-bottom:8px;}
  .modal-text-note{background:rgba(196,147,58,0.08);border-left:3px solid var(--sepia);border-radius:0 8px 8px 0;padding:12px 14px;font-size:0.87rem;line-height:1.6;margin-bottom:8px;}

  /* POPUP */
  .leaflet-control-layers{background:white !important;border:1.5px solid rgba(196,147,58,0.35) !important;border-radius:10px !important;box-shadow:0 4px 16px rgba(0,0,0,0.15) !important;font-family:'DM Sans',sans-serif !important;}
  .leaflet-control-layers label{font-size:0.82rem !important;font-weight:500 !important;color:#1a1208 !important;padding:5px 10px !important;border-radius:6px !important;cursor:pointer !important;display:flex !important;align-items:center !important;gap:6px !important;text-transform:none !important;letter-spacing:normal !important;}
  .leaflet-control-layers label:hover{background:rgba(196,147,58,0.1) !important;}
  .leaflet-control-layers-selector{accent-color:#c4933a;margin-right:4px !important;}
  .leaflet-popup-content-wrapper{border-radius:10px;box-shadow:0 4px 20px rgba(0,0,0,0.2);font-family:'DM Sans',sans-serif;}
  .popup-open-btn{display:inline-flex;align-items:center;gap:5px;margin-top:10px;padding:8px 16px;background:var(--rust);color:white;border:none;border-radius:20px;font-family:'DM Sans',sans-serif;font-size:0.8rem;font-weight:500;cursor:pointer;}
  .popup-title{font-family:'Playfair Display',serif;font-size:1rem;font-weight:700;color:var(--ink);margin-bottom:3px;}
  .popup-cat{font-size:0.72rem;font-weight:500;text-transform:uppercase;letter-spacing:0.05em;color:var(--sepia);margin-bottom:5px;}
  .popup-desc{font-size:0.82rem;color:rgba(26,18,8,0.7);line-height:1.5;margin-bottom:5px;}
  .popup-meta{font-size:0.72rem;color:rgba(26,18,8,0.5);}
  .popup-media-row{display:flex;gap:5px;margin-top:7px;flex-wrap:wrap;}
  .popup-media-badge{font-size:0.72rem;background:rgba(196,147,58,0.12);padding:3px 8px;border-radius:10px;color:var(--sepia);font-weight:500;}
  .popup-thumb{width:100%;max-height:140px;object-fit:cover;border-radius:8px;margin-top:8px;cursor:pointer;}

  .toast{position:fixed;bottom:24px;right:24px;background:var(--ink);color:var(--parchment);padding:13px 18px;border-radius:10px;font-size:0.84rem;z-index:9999;transform:translateY(100px);opacity:0;transition:transform 0.3s,opacity 0.3s;max-width:300px;box-shadow:0 8px 32px rgba(0,0,0,0.3);border-left:3px solid var(--sepia);}
  .toast.show{transform:translateY(0);opacity:1;}
  .toast.success{border-left-color:var(--moss);}
  .toast.error{border-left-color:var(--rust);}
  .empty-state{text-align:center;padding:24px 16px;color:rgba(26,18,8,0.35);}
  .empty-state p{font-size:0.84rem;line-height:1.5;}
  ::-webkit-scrollbar{width:4px;}
  ::-webkit-scrollbar-thumb{background:rgba(196,147,58,0.3);border-radius:4px;}
  .loading{display:inline-block;width:16px;height:16px;border:2px solid rgba(255,255,255,0.3);border-top-color:white;border-radius:50%;animation:spin 0.7s linear infinite;}
  @keyframes spin{to{transform:rotate(360deg)}}
  @media(max-width:768px){
    .app{grid-template-columns:1fr;grid-template-rows:auto 1fr;}
    .sidebar{max-height:55vh;border-right:none;border-bottom:1px solid rgba(196,147,58,0.3);}
    #map{height:45vh;}
  }
</style>
</head>
<body>
<header>
  <div class="logo">PK <span>Explorer</span></div>
  <div class="header-right">
    <div class="status-dot" id="statusDot"></div>
    <span class="status-label" id="statusLabel">Conectando...</span>
  </div>
</header>

<div class="app">
  <div class="sidebar">
    <div class="sidebar-tabs" style="padding-top:4px;">
      <button class="tab-btn active" id="tbtn-form">‚úèÔ∏è Registrar</button>
      <button class="tab-btn" id="tbtn-list">üìç Pontos</button>
      <button class="tab-btn" id="tbtn-students">üë• Alunos/Eletiva</button>
    </div>

    <!-- ===== TAB REGISTRAR ===== -->
    <div class="tab-panel active" id="tab-form">
      <div class="form-area">
        <div class="form-group">
          <label>Aluno respons√°vel</label>
          <select id="authorSelect"><option value="">Selecionar aluno...</option></select>
        </div>
        <div class="form-group">
          <label>Nome do ponto hist√≥rico</label>
          <input type="text" id="pointName" placeholder="Ex: Casar√£o da Fam√≠lia Ferreira">
        </div>
        <div class="form-group">
          <label>Categoria</label>
          <select id="category">
            <option value="">Selecionar...</option>
            <option value="Arquitetura">üèõÔ∏è Arquitetura</option>
            <option value="Pr√©dio P√∫blico/Privado">üè¢ Pr√©dio P√∫blico/Privado</option>
            <option value="Cultura">üé≠ Cultura e Arte</option>
            <option value="Monumento Hist√≥rico">üóø Monumento Hist√≥rico</option>
            <option value="Marco Geogr√°fico">üó∫Ô∏è Marco Geogr√°fico</option>
            <option value="Personalidade">üë§ Personalidade Hist√≥rica</option>
            <option value="Religi√£o">‚õ™ Religi√£o</option>
            <option value="Natureza">üåø Natureza</option>
            <option value="Outro">üìå Outro</option>
          </select>
        </div>
        <div class="form-group">
          <label>Descri√ß√£o hist√≥rica</label>
          <textarea id="description" placeholder="Descreva o significado hist√≥rico deste lugar..."></textarea>
        </div>

        <!-- M√çDIA ‚Äî chips clic√°veis -->
        <div class="form-group">
          <label>M√≠dias (opcional)</label>
          <div class="media-chips">
            <div class="media-chip" id="chip-photos">
              <span class="media-chip-icon">üì∑</span> Fotos
            </div>
            <div class="media-chip" id="chip-videos">
              <span class="media-chip-icon">üé¨</span> V√≠deos
            </div>
            <div class="media-chip" id="chip-audio">
              <span class="media-chip-icon">üéôÔ∏è</span> √Åudio
            </div>
            <div class="media-chip" id="chip-texts">
              <span class="media-chip-icon">üìù</span> Anota√ß√£o
            </div>
          </div>

          <!-- Painel Fotos -->
          <div class="media-panel" id="panel-photos">
            <div class="upload-zone" id="uploadZonePhoto">
              <span class="upload-zone-icon">üì∑</span>
              <p style="font-weight:500;color:rgba(26,18,8,0.7)">Adicionar fotos ao ponto</p>
              <p style="font-size:0.7rem;opacity:.6;margin-bottom:10px">No celular: use a c√¢mera ou a galeria</p>
              <div style="display:flex;gap:8px;justify-content:center;flex-wrap:wrap;">
                <button class="upload-btn" id="btnCamera" style="background:#3d6b4f;">üì∑ C√¢mera (tirar agora)</button>
                <button class="upload-btn" id="btnSelectPhoto">üñºÔ∏è Galeria / arquivo</button>
              </div>
              <p style="font-size:0.68rem;color:rgba(26,18,8,0.3);margin-top:8px;">M√∫ltiplas fotos permitidas</p>
              <input type="file" id="photoCameraInput" accept="image/*" capture="environment">
              <input type="file" id="photoInput" accept="image/*" multiple>
            </div>
            <div class="media-preview" id="photoPreview"></div>
          </div>

          <!-- Painel V√≠deos -->
          <div class="media-panel" id="panel-videos">
            <div class="upload-zone">
              <span class="upload-zone-icon">üé¨</span>
              <p>Toque para selecionar v√≠deos</p>
              <p style="font-size:0.7rem;opacity:.6">MP4, MOV</p>
              <button class="upload-btn" id="btnSelectVideo">Selecionar v√≠deos</button>
              <input type="file" id="videoInput" accept="video/*" multiple>
            </div>
            <div class="media-preview" id="videoPreview"></div>
          </div>

          <!-- Painel √Åudio -->
          <div class="media-panel" id="panel-audio">
            <div class="audio-recorder">
              <div class="recorder-controls">
                <button class="rec-btn record" id="recStartBtn">‚è∫ Gravar</button>
                <button class="rec-btn stop" id="recStopBtn" disabled>‚èπ Parar</button>
                <span class="rec-timer" id="recTimer">00:00</span>
                <span class="rec-dot" id="recDot" style="display:none"></span>
              </div>
              <p style="font-size:0.72rem;color:rgba(26,18,8,0.4);margin-bottom:8px;">Grave uma narra√ß√£o sobre o local</p>
              <div class="audio-list" id="audioList"></div>
            </div>
          </div>

          <!-- Painel Texto -->
          <div class="media-panel" id="panel-texts">
            <label style="margin-bottom:6px">Anota√ß√µes, fontes ou curiosidades</label>
            <textarea id="extraText" placeholder="Ex: Segundo o livro X, este local foi palco de..." style="min-height:80px"></textarea>
          </div>
        </div>

        <div class="form-group">
          <label>Localiza√ß√£o GPS</label>
          <div class="gps-row">
            <input type="text" id="lat" placeholder="Latitude" readonly>
            <input type="text" id="lng" placeholder="Longitude" readonly>
            <button class="gps-btn" id="btnGPS">
              <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><circle cx="12" cy="12" r="3"/><path d="M12 2v4M12 18v4M2 12h4M18 12h4"/></svg>
              Usar minha localiza√ß√£o atual
            </button>
          </div>
        </div>
        <button class="submit-btn" id="submitBtn">üìå Registrar Ponto Hist√≥rico</button>
      </div>
    </div>

    <!-- ===== TAB PONTOS ===== -->
    <div class="tab-panel" id="tab-list">
      <div class="points-list-area">
        <div class="list-header">Pontos registrados <span class="count-badge" id="countBadge">0</span></div>
        <div id="pointsList"><div class="empty-state"><p>Nenhum ponto cadastrado ainda.</p></div></div>
      </div>
    </div>

    <!-- ===== TAB ALUNOS ===== -->
    <div class="tab-panel" id="tab-students">
      <div class="students-area">
        <div class="students-header">
          <div class="students-title">üë• Alunos / Eletiva</div>
          <div class="students-actions" style="flex-wrap:wrap;gap:6px;">
            <button class="btn-sm outline" id="btnToggleAddForm" title="M√°x. 32 alunos">+ Aluno <span id="cntAlunos" style="font-size:0.68rem;opacity:0.7">(0/32)</span></button>
            <button class="btn-sm outline" id="btnToggleProfForm" style="border-color:#3d6b4f;color:#3d6b4f;" title="M√°x. 2 professores">+ Professor <span id="cntProfs" style="font-size:0.68rem;opacity:0.7">(0/2)</span></button>
            <button class="btn-sm secondary" id="btnPDF">üìÑ PDF</button>
          </div>
        </div>
        <div class="report-stats">
          <div class="stat-box"><div class="stat-num" id="statAlunos">0</div><div class="stat-lbl">Alunos</div></div>
          <div class="stat-box"><div class="stat-num" id="statPontos">0</div><div class="stat-lbl">Pontos</div></div>
          <div class="stat-box"><div class="stat-num" id="statParticip">0</div><div class="stat-lbl">Participaram</div></div>
        </div>
        <div id="limitBanner" style="display:none" class="limit-banner">üîí Limite de 34 participantes atingido.<br>Todos os alunos e professores j√° est√£o cadastrados.</div>
        <div class="add-student-form" id="addStudentForm">
          <div class="add-student-row" style="margin-bottom:10px">
            <div class="full form-group" style="margin-bottom:10px">
              <label>Nome completo *</label>
              <input type="text" id="sName" placeholder="Nome do aluno ou professor">
            </div>
            <div class="form-group" style="margin-bottom:0">
              <label>Turma</label>
              <input type="text" id="sTurma" placeholder="Ex: 9¬∫A">
            </div>
            <div class="form-group" style="margin-bottom:0">
              <label>N¬∫</label>
              <input type="number" id="sNum" placeholder="01" min="1" max="50">
            </div>
          </div>
          <div style="display:flex;gap:8px">
            <button class="btn-sm primary" id="btnAddStudent" style="flex:1">Salvar</button>
            <button class="btn-sm outline" id="btnCancelAdd">Cancelar</button>
          </div>
        </div>
        <!-- FORM PROFESSOR -->
        <div class="add-student-form" id="addProfForm">
          <div style="background:rgba(61,107,79,0.08);border-radius:8px;padding:8px 12px;margin-bottom:10px;font-size:0.78rem;color:#3d6b4f;font-weight:500;">üë®‚Äçüè´ Cadastrar professor ‚Äî m√°x. 2 vagas</div>
          <div class="add-student-row" style="margin-bottom:10px">
            <div class="full form-group" style="margin-bottom:10px">
              <label>Nome completo *</label>
              <input type="text" id="pName" placeholder="Nome do professor">
            </div>
            <div class="full form-group" style="margin-bottom:0">
              <label>Disciplina</label>
              <input type="text" id="pDisciplina" placeholder="Ex: Hist√≥ria">
            </div>
          </div>
          <div style="display:flex;gap:8px">
            <button class="btn-sm primary" id="btnAddProf" style="background:#3d6b4f;flex:1">Salvar professor</button>
            <button class="btn-sm outline" id="btnCancelProf">Cancelar</button>
          </div>
        </div>

        <div class="ranking-section" id="rankingSection" style="display:none">
          <div class="section-label">üèÜ Ranking de cadastros</div>
          <div id="rankingList"></div>
        </div>
        <div class="student-list-wrap" id="studentList">
          <div class="empty-state"><p>Nenhum aluno cadastrado.<br>Clique em "+ Aluno" para come√ßar.</p></div>
        </div>
      </div>
    </div>
  </div>

  <div id="map"></div>
</div>

<!-- MODAL PONTO -->
<div class="modal-overlay" id="modalOverlay">
  <div class="modal">
    <div class="modal-header">
      <div><div class="modal-title" id="modalTitle"></div><div class="modal-cat" id="modalCat"></div></div>
      <button class="modal-close" id="btnCloseModal">√ó</button>
    </div>
    <div class="modal-body" id="modalBody"></div>
  </div>
</div>

<div class="toast" id="toast"></div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.js"></script>
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-app.js";
import { getFirestore, collection, addDoc, onSnapshot, serverTimestamp, query, orderBy, doc, setDoc, deleteDoc } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-firestore.js";
import { getStorage, ref as sRef, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-storage.js";

const firebaseConfig = {
  apiKey: "AIzaSyAw3_toa8iNQEHv_NostV1wt0t2lqHcoqg",
  authDomain: "pk-explorer.firebaseapp.com",
  databaseURL: "https://pk-explorer-default-rtdb.firebaseio.com",
  projectId: "pk-explorer",
  storageBucket: "pk-explorer.firebasestorage.app",
  messagingSenderId: "731000410555",
  appId: "1:731000410555:web:d715162b1bb96787f1349e"
};

const LIMITE_PARTICIPANTES = 34; // 32 alunos + 2 professores

const fbApp = initializeApp(firebaseConfig);
const db = getFirestore(fbApp);
const storage = getStorage(fbApp);

// ===== MAPA =====
const map = L.map('map', { zoomControl: false }).setView([-5.28, -44.47], 14);
L.control.zoom({ position: 'bottomright' }).addTo(map);
// Rua: OpenStreetMap nativo ‚Äî cobertura completa do Brasil
const layerRua = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
  attribution:'¬© OpenStreetMap contributors', minZoom:1, maxZoom:19, maxNativeZoom:19
});
// Satelite: Google ‚Äî excelente cobertura do interior do Brasil
const layerSat = L.tileLayer('https://mt1.google.com/vt/lyrs=s&x={x}&y={y}&z={z}', {
  attribution:'¬© Google', minZoom:1, maxZoom:20, maxNativeZoom:20
});
// Hibrid: Google satelite + nomes de ruas
const layerHibrid = L.tileLayer('https://mt1.google.com/vt/lyrs=y&x={x}&y={y}&z={z}', {
  attribution:'¬© Google', minZoom:1, maxZoom:20, maxNativeZoom:20
});
layerRua.addTo(map);
L.control.layers({'üó∫Ô∏è Rua':layerRua,'üõ∞Ô∏è Sat√©lite':layerSat,'üõ∞Ô∏è+üó∫Ô∏è H√≠brido':layerHibrid},{},{position:'topright',collapsed:false}).addTo(map);

// ===== ESTADO =====
let mediaFiles = { photo:[], video:[] }, audioBlobs = [];
let mediaRecorder = null, recChunks = [], recInterval = null, recSeconds = 0;
let pointsData = {}, students = {};
const markers = {};
let activeMarkerKey = null;
let activeChip = null;

// ===== TOAST =====
function showToast(msg, type='') {
  const t = document.getElementById('toast');
  t.textContent = msg; t.className = `toast show ${type}`;
  setTimeout(() => t.className = 'toast', 3200);
}

// ===== TABS =====
function switchTab(tab) {
  ['form','list','students'].forEach(t => {
    document.getElementById('tab-'+t).classList.toggle('active', t===tab);
    document.getElementById('tbtn-'+t).classList.toggle('active', t===tab);
  });
}
document.getElementById('tbtn-form').addEventListener('click', () => switchTab('form'));
document.getElementById('tbtn-list').addEventListener('click', () => switchTab('list'));
document.getElementById('tbtn-students').addEventListener('click', () => switchTab('students'));

// ===== MEDIA CHIPS =====
function openChip(name) {
  if (activeChip === name) {
    document.getElementById('panel-'+name).classList.remove('open');
    document.getElementById('chip-'+name).classList.remove('active');
    activeChip = null; return;
  }
  if (activeChip) {
    document.getElementById('panel-'+activeChip).classList.remove('open');
    document.getElementById('chip-'+activeChip).classList.remove('active');
  }
  document.getElementById('panel-'+name).classList.add('open');
  document.getElementById('chip-'+name).classList.add('active');
  activeChip = name;
}
['photos','videos','audio','texts'].forEach(n =>
  document.getElementById('chip-'+n).addEventListener('click', () => openChip(n))
);

// ===== UPLOAD FOTOS/V√çDEOS =====
document.getElementById('btnSelectPhoto').addEventListener('click', () => document.getElementById('photoInput').click());
document.getElementById('btnCamera').addEventListener('click', () => document.getElementById('photoCameraInput').click());
document.getElementById('btnSelectVideo').addEventListener('click', () => document.getElementById('videoInput').click());

// C√¢mera direta (capture="environment" = c√¢mera traseira)
document.getElementById('photoCameraInput').addEventListener('change', function() {
  Array.from(this.files).forEach(file => {
    mediaFiles.photo.push(file);
    const thumb = document.createElement('div'); thumb.className = 'media-thumb';
    const img = document.createElement('img'); img.src = URL.createObjectURL(file);
    thumb.appendChild(img);
    const rm = document.createElement('button'); rm.className = 'remove-btn'; rm.textContent = '√ó';
    const idx = mediaFiles.photo.length - 1;
    rm.onclick = () => { mediaFiles.photo.splice(idx, 1); thumb.remove(); };
    thumb.appendChild(rm);
    document.getElementById('photoPreview').appendChild(thumb);
  });
  this.value = '';
});

document.getElementById('photoInput').addEventListener('change', function() {
  Array.from(this.files).forEach(file => {
    mediaFiles.photo.push(file);
    const thumb = document.createElement('div'); thumb.className = 'media-thumb';
    const img = document.createElement('img'); img.src = URL.createObjectURL(file);
    thumb.appendChild(img);
    const rm = document.createElement('button'); rm.className = 'remove-btn'; rm.textContent = '√ó';
    const idx = mediaFiles.photo.length - 1;
    rm.onclick = () => { mediaFiles.photo.splice(idx, 1); thumb.remove(); };
    thumb.appendChild(rm);
    document.getElementById('photoPreview').appendChild(thumb);
  });
  this.value = '';
});

document.getElementById('videoInput').addEventListener('change', function() {
  Array.from(this.files).forEach(file => {
    mediaFiles.video.push(file);
    const thumb = document.createElement('div'); thumb.className = 'media-thumb';
    const vid = document.createElement('video'); vid.src = URL.createObjectURL(file);
    thumb.appendChild(vid);
    const rm = document.createElement('button'); rm.className = 'remove-btn'; rm.textContent = '√ó';
    const idx = mediaFiles.video.length - 1;
    rm.onclick = () => { mediaFiles.video.splice(idx, 1); thumb.remove(); };
    thumb.appendChild(rm);
    document.getElementById('videoPreview').appendChild(thumb);
  });
  this.value = '';
});

// ===== √ÅUDIO =====
document.getElementById('recStartBtn').addEventListener('click', async () => {
  try {
    const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
    recChunks = []; mediaRecorder = new MediaRecorder(stream);
    mediaRecorder.ondataavailable = e => recChunks.push(e.data);
    mediaRecorder.onstop = () => {
      const blob = new Blob(recChunks, { type: 'audio/webm' });
      audioBlobs.push(blob);
      const url = URL.createObjectURL(blob);
      const idx = audioBlobs.length - 1;
      const item = document.createElement('div'); item.className = 'audio-item';
      item.innerHTML = `<audio controls src="${url}"></audio>`;
      const rm = document.createElement('button'); rm.className = 'remove-btn'; rm.textContent = '√ó';
      rm.onclick = () => { audioBlobs[idx] = null; item.remove(); };
      item.appendChild(rm);
      document.getElementById('audioList').appendChild(item);
      stream.getTracks().forEach(t => t.stop());
      showToast('üéôÔ∏è √Åudio gravado!', 'success');
    };
    mediaRecorder.start(); recSeconds = 0;
    document.getElementById('recTimer').textContent = '00:00';
    document.getElementById('recDot').style.display = 'inline-block';
    document.getElementById('recStartBtn').disabled = true;
    document.getElementById('recStopBtn').disabled = false;
    recInterval = setInterval(() => {
      recSeconds++;
      document.getElementById('recTimer').textContent =
        String(Math.floor(recSeconds/60)).padStart(2,'0') + ':' + String(recSeconds%60).padStart(2,'0');
    }, 1000);
  } catch { showToast('Sem acesso ao microfone.', 'error'); }
});

document.getElementById('recStopBtn').addEventListener('click', () => {
  if (mediaRecorder?.state !== 'inactive') {
    mediaRecorder.stop(); clearInterval(recInterval);
    document.getElementById('recDot').style.display = 'none';
    document.getElementById('recStartBtn').disabled = false;
    document.getElementById('recStopBtn').disabled = true;
  }
});

// ===== GPS =====
document.getElementById('btnGPS').addEventListener('click', () => {
  if (!navigator.geolocation) { showToast('GPS n√£o dispon√≠vel.', 'error'); return; }
  const btn = document.getElementById('btnGPS');
  btn.innerHTML = '<div class="loading"></div> Obtendo...'; btn.disabled = true;
  navigator.geolocation.getCurrentPosition(pos => {
    document.getElementById('lat').value = pos.coords.latitude.toFixed(6);
    document.getElementById('lng').value = pos.coords.longitude.toFixed(6);
    map.flyTo([pos.coords.latitude, pos.coords.longitude], 17, { duration: 1.2 });
    btn.innerHTML = `<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><circle cx="12" cy="12" r="3"/><path d="M12 2v4M12 18v4M2 12h4M18 12h4"/></svg> ‚úì Localiza√ß√£o capturada`;
    btn.disabled = false; showToast('üìç Localiza√ß√£o capturada!', 'success');
  }, () => {
    btn.innerHTML = `<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><circle cx="12" cy="12" r="3"/><path d="M12 2v4M12 18v4M2 12h4M18 12h4"/></svg> Usar minha localiza√ß√£o atual`;
    btn.disabled = false; showToast('Erro ao obter GPS.', 'error');
  }, { enableHighAccuracy: true, timeout: 10000 });
});

// Clique no mapa define coordenadas
map.on('click', e => {
  document.getElementById('lat').value = e.latlng.lat.toFixed(6);
  document.getElementById('lng').value = e.latlng.lng.toFixed(6);
  showToast('üìç Coordenadas definidas pelo clique.');
});

// ===== √çCONE =====
function createIcon(big = false) {
  const s = big ? 38 : 30;
  return L.divIcon({
    className: '',
    html: `<div style="position:relative;width:${s}px;height:${s+8}px">
      <div style="width:${s}px;height:${s}px;background:#3d6b4f;border:3px solid white;border-radius:50% 50% 50% 0;transform:rotate(-45deg);box-shadow:0 ${big?6:2}px ${big?20:8}px rgba(0,0,0,${big?0.45:0.3})"></div>
      <div style="position:absolute;bottom:0;left:50%;transform:translateX(-50%);width:${big?10:6}px;height:3px;background:rgba(0,0,0,0.2);border-radius:50%;filter:blur(2px)"></div>
    </div>`,
    iconSize: [s, s+8], iconAnchor: [s/2, s+8], popupAnchor: [0, -(s+12)]
  });
}

// ===== MODAL =====
function openModal(id) {
  const d = pointsData[id]; if (!d) return;
  document.getElementById('modalTitle').textContent = d.name;
  document.getElementById('modalCat').textContent = d.category;
  const hora = d.createdAt?.toDate ? d.createdAt.toDate().toLocaleString('pt-BR') : (d.createdAt ? new Date(d.createdAt).toLocaleString('pt-BR') : '‚Äî');
  let body = `
    <div class="modal-meta">
      <div class="modal-meta-item">üë§ <strong>${d.author}</strong></div>
      <div class="modal-meta-item">üïê ${hora}</div>
      <div class="modal-meta-item">üìç ${d.lat?.toFixed(5)}, ${d.lng?.toFixed(5)}</div>
    </div>
    <div class="modal-desc">${d.description || 'Sem descri√ß√£o.'}</div>`;
  if (d.photos?.length) {
    body += `<div class="modal-media-section"><div class="modal-media-label">üì∑ Fotos (${d.photos.length})</div><div class="modal-photos">`;
    d.photos.forEach(u => { body += `<img class="modal-photo" src="${u}" onclick="window.open('${u}','_blank')" loading="lazy">`; });
    body += `</div></div>`;
  }
  if (d.videos?.length) {
    body += `<div class="modal-media-section"><div class="modal-media-label">üé¨ V√≠deos</div>`;
    d.videos.forEach(u => { body += `<video class="modal-video" controls src="${u}"></video>`; });
    body += `</div>`;
  }
  if (d.audios?.length) {
    body += `<div class="modal-media-section"><div class="modal-media-label">üéôÔ∏è √Åudios</div>`;
    d.audios.forEach(u => { body += `<audio class="modal-audio" controls src="${u}"></audio>`; });
    body += `</div>`;
  }
  if (d.extraText) body += `<div class="modal-media-section"><div class="modal-media-label">üìù Anota√ß√µes</div><div class="modal-text-note">${d.extraText}</div></div>`;
  document.getElementById('modalBody').innerHTML = body;
  document.getElementById('modalOverlay').classList.add('open');
}

document.getElementById('btnCloseModal').addEventListener('click', () => document.getElementById('modalOverlay').classList.remove('open'));
document.getElementById('modalOverlay').addEventListener('click', function(e) { if (e.target === this) this.classList.remove('open'); });

// ===== RENDER PONTO NO MAPA E LISTA =====
function renderPoint(id, data) {
  pointsData[id] = data;

  // Marker no mapa ‚Äî sempre verde, sem status "pendente"
  if (!markers[id] && data.lat && data.lng) {
    const badges = [];
    if (data.photos?.length) badges.push(`üì∑ ${data.photos.length}`);
    if (data.videos?.length) badges.push(`üé¨ ${data.videos.length}`);
    if (data.audios?.length) badges.push(`üéôÔ∏è ${data.audios.length}`);
    if (data.extraText) badges.push('üìù');

    const hora = data.createdAt?.toDate ? data.createdAt.toDate().toLocaleTimeString('pt-BR',{hour:'2-digit',minute:'2-digit'}) : '‚Äî';
    const thumbHTML = data.photos?.length ? `<img class="popup-thumb" src="${data.photos[0]}" onclick="window.open('${data.photos[0]}','_blank')">` : '';

    const popup = L.popup({ autoPan: true, maxWidth: 280 }).setContent(`
      <div style="min-width:220px">
        <div class="popup-title">${data.name}</div>
        <div class="popup-cat">${data.category}</div>
        <div class="popup-desc">${(data.description||'').substring(0,120)}${(data.description||'').length>120?'...':''}</div>
        <div class="popup-meta">üë§ ${data.author} ¬∑ üïê ${hora}</div>
        ${badges.length ? `<div class="popup-media-row">${badges.map(b=>`<span class="popup-media-badge">${b}</span>`).join('')}</div>` : ''}
        ${thumbHTML}
        <button class="popup-open-btn" onclick="window._openModal('${id}')">Ver tudo ‚Üí</button>
      </div>`);

    const marker = L.marker([data.lat, data.lng], { icon: createIcon(false) });
    marker.bindPopup(popup);

    function flyAndOpen() {
      if (activeMarkerKey && activeMarkerKey !== id && markers[activeMarkerKey])
        markers[activeMarkerKey].setIcon(createIcon(false));
      activeMarkerKey = id;
      marker.setIcon(createIcon(true));
      const tll = L.latLng(data.lat, data.lng);
      if (map.getZoom() >= 17 && map.getBounds().contains(tll)) { marker.openPopup(); return; }
      map.flyTo(tll, 18, { duration: 1.2, easeLinearity: 0.4 });
      const onZE = () => { map.off('zoomend', onZE); setTimeout(() => marker.openPopup(), 120); };
      map.on('zoomend', onZE);
    }

    marker.on('click', e => { L.DomEvent.stopPropagation(e); flyAndOpen(); });
    marker.on('popupclose', () => { marker.setIcon(createIcon(false)); activeMarkerKey = null; });
    marker.addTo(map);
    markers[id] = marker;
    markers[id]._flyAndOpen = flyAndOpen;
  }

  // Card na lista
  let card = document.getElementById(`card-${id}`);
  if (!card) {
    card = document.createElement('div');
    card.id = `card-${id}`; card.className = 'point-card';
    card.addEventListener('click', () => { switchTab('list'); markers[id]?._flyAndOpen?.(); });
    const empty = document.querySelector('#pointsList .empty-state');
    if (empty) empty.remove();
    document.getElementById('pointsList').insertBefore(card, document.getElementById('pointsList').firstChild);
  }
  const mb = [];
  if (data.photos?.length) mb.push(`üì∑ ${data.photos.length}`);
  if (data.videos?.length) mb.push(`üé¨ ${data.videos.length}`);
  if (data.audios?.length) mb.push(`üéôÔ∏è ${data.audios.length}`);
  if (data.extraText) mb.push('üìù');
  card.innerHTML = `<div class="point-title">${data.name}</div>
    <div class="point-meta">
      <span class="category-tag">${data.category}</span>
      <span>üë§ ${data.author}</span>
    </div>
    ${mb.length ? `<div class="point-media-icons">${mb.map(b=>`<span class="media-icon-badge">${b}</span>`).join('')}</div>` : ''}`;

  document.getElementById('countBadge').textContent = Object.keys(markers).length;
  updateStats();
}

// expor openModal para o popup HTML inline
window._openModal = openModal;

// ===== UPLOAD M√çDIAS =====
async function uploadFiles(pointId) {
  const urls = { photos:[], videos:[], audios:[] };
  const up = async (file, path) => {
    const r = sRef(storage, path);
    await uploadBytes(r, file);
    return getDownloadURL(r);
  };
  for (const [i,f] of mediaFiles.photo.entries()) urls.photos.push(await up(f, `pontos/${pointId}/foto_${i}`));
  for (const [i,f] of mediaFiles.video.entries()) urls.videos.push(await up(f, `pontos/${pointId}/video_${i}`));
  for (const [i,b] of audioBlobs.filter(Boolean).entries()) urls.audios.push(await up(b, `pontos/${pointId}/audio_${i}`));
  return urls;
}

// ===== SUBMIT PONTO =====
document.getElementById('submitBtn').addEventListener('click', async () => {
  const author = document.getElementById('authorSelect').value;
  const name = document.getElementById('pointName').value.trim();
  const category = document.getElementById('category').value;
  const description = document.getElementById('description').value.trim();
  const extraText = document.getElementById('extraText').value.trim();
  const lat = parseFloat(document.getElementById('lat').value);
  const lng = parseFloat(document.getElementById('lng').value);

  if (!author) { showToast('Selecione o aluno respons√°vel.', 'error'); return; }
  if (!name || !category) { showToast('Preencha nome e categoria.', 'error'); return; }
  if (isNaN(lat) || isNaN(lng)) { showToast('Capture a localiza√ß√£o GPS primeiro.', 'error'); return; }

  const btn = document.getElementById('submitBtn');
  btn.disabled = true; btn.innerHTML = '<div class="loading"></div> Enviando...';

  const pointId = 'pt_' + Date.now();
  let mediaUrls = { photos:[], videos:[], audios:[] };
  try { mediaUrls = await uploadFiles(pointId); }
  catch(e) { console.error(e); showToast('Erro no upload de m√≠dias.', 'error'); }

  try {
    await addDoc(collection(db, 'pontos'), {
      name, author, category, description, extraText,
      lat, lng, ...mediaUrls,
      createdAt: serverTimestamp()
    });
    showToast('‚úÖ Ponto registrado!', 'success');
  } catch(e) {
    console.error(e); showToast('Erro ao salvar. Verifique a conex√£o.', 'error');
    btn.disabled = false; btn.innerHTML = 'üìå Registrar Ponto Hist√≥rico'; return;
  }

  // Limpar form
  ['pointName','description','lat','lng','extraText'].forEach(id => { const el = document.getElementById(id); if(el) el.value=''; });
  document.getElementById('category').value = '';
  document.getElementById('authorSelect').value = '';
  document.getElementById('photoPreview').innerHTML = '';
  document.getElementById('videoPreview').innerHTML = '';
  document.getElementById('audioList').innerHTML = '';
  mediaFiles = { photo:[], video:[] }; audioBlobs = [];
  // Fechar chips
  ['photos','videos','audio','texts'].forEach(n => {
    document.getElementById('panel-'+n).classList.remove('open');
    document.getElementById('chip-'+n).classList.remove('active');
  });
  activeChip = null;
  document.getElementById('btnGPS').innerHTML = `<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><circle cx="12" cy="12" r="3"/><path d="M12 2v4M12 18v4M2 12h4M18 12h4"/></svg> Usar minha localiza√ß√£o atual`;
  btn.disabled = false; btn.innerHTML = 'üìå Registrar Ponto Hist√≥rico';
  switchTab('list');
});

// ===== ALUNOS =====
function checkLimit() {
  const allStudents = Object.values(students);
  const nAlunos = allStudents.filter(s => s.tipo !== 'professor').length;
  const nProfs  = allStudents.filter(s => s.tipo === 'professor').length;
  const alunosOk = nAlunos >= 32;
  const profsOk  = nProfs  >= 2;
  const tudo     = alunosOk && profsOk;

  // contadores nos bot√µes
  document.getElementById('cntAlunos').textContent = `(${nAlunos}/32)`;
  document.getElementById('cntProfs').textContent  = `(${nProfs}/2)`;

  // bloquear bot√µes individualmente
  document.getElementById('btnToggleAddForm').disabled = alunosOk;
  document.getElementById('btnToggleProfForm').disabled = profsOk;
  if (alunosOk) document.getElementById('addStudentForm').classList.remove('open');
  if (profsOk)  document.getElementById('addProfForm').classList.remove('open');

  // banner s√≥ aparece quando tudo completo
  document.getElementById('limitBanner').style.display = tudo ? 'block' : 'none';
  document.getElementById('limitBanner').textContent = tudo
    ? 'üîí Todos os 32 alunos e 2 professores j√° est√£o cadastrados.'
    : '';
  return tudo;
}

document.getElementById('btnToggleAddForm').addEventListener('click', () => {
  if (checkLimit()) return;
  const f = document.getElementById('addStudentForm');
  f.classList.toggle('open');
  if (f.classList.contains('open')) document.getElementById('sName').focus();
});
document.getElementById('btnCancelAdd').addEventListener('click', () => {
  document.getElementById('addStudentForm').classList.remove('open');
});

// ===== PROFESSOR =====
document.getElementById('btnToggleProfForm').addEventListener('click', () => {
  const f = document.getElementById('addProfForm');
  f.classList.toggle('open');
  if (f.classList.contains('open')) document.getElementById('pName').focus();
});
document.getElementById('btnCancelProf').addEventListener('click', () => {
  document.getElementById('addProfForm').classList.remove('open');
});
document.getElementById('btnAddProf').addEventListener('click', async () => {
  const nProfs = Object.values(students).filter(s => s.tipo === 'professor').length;
  if (nProfs >= 2) { showToast('Limite de 2 professores atingido!', 'error'); return; }
  const name = document.getElementById('pName').value.trim();
  const disciplina = document.getElementById('pDisciplina').value.trim();
  if (!name) { showToast('Informe o nome do professor.', 'error'); return; }
  if (Object.values(students).some(s => s.name.toLowerCase() === name.toLowerCase())) {
    showToast('J√° existe um participante com esse nome.', 'error'); return;
  }
  const id = 'prof_' + Date.now();
  const sData = { name, disciplina, tipo: 'professor', num: '', turma: '', createdAt: new Date().toISOString() };
  students[id] = sData;
  try { await setDoc(doc(db, 'alunos', id), sData); }
  catch { showToast('Erro ao salvar professor.', 'error'); return; }
  renderStudents();
  document.getElementById('pName').value = '';
  document.getElementById('pDisciplina').value = '';
  document.getElementById('addProfForm').classList.remove('open');
  showToast(`‚úÖ Prof. ${name} adicionado!`, 'success');
  checkLimit();
});

document.getElementById('btnAddStudent').addEventListener('click', async () => {
  if (checkLimit()) { showToast('Limite de participantes atingido!', 'error'); return; }
  const name = document.getElementById('sName').value.trim();
  const turma = document.getElementById('sTurma').value.trim();
  const num = document.getElementById('sNum').value.trim();
  if (!name) { showToast('Informe o nome.', 'error'); return; }
  // Verificar duplicata
  if (Object.values(students).some(s => s.name.toLowerCase() === name.toLowerCase())) {
    showToast('J√° existe um participante com esse nome.', 'error'); return;
  }
  const id = 'aluno_' + Date.now();
  const sData = { name, turma, num, tipo: 'aluno', createdAt: new Date().toISOString() };
  students[id] = sData;
  try { await setDoc(doc(db, 'alunos', id), sData); }
  catch { showToast('Erro ao salvar aluno.', 'error'); return; }
  renderStudents();
  document.getElementById('sName').value = '';
  document.getElementById('sTurma').value = '';
  document.getElementById('sNum').value = '';
  document.getElementById('addStudentForm').classList.remove('open');
  showToast(`‚úÖ ${name} adicionado!`, 'success');
  checkLimit();
});

// Senha do professor para apagar participantes
const SENHA_PROF = 'pk2025';

window.deleteStudentAuth = async function(id, nome) {
  const senha = prompt(`üîí Para remover "${nome}", digite a senha do professor:`);
  if (senha === null) return; // cancelou
  if (senha !== SENHA_PROF) { showToast('Senha incorreta.', 'error'); return; }
  if (!confirm(`Confirmar remo√ß√£o de "${nome}"?`)) return;
  delete students[id];
  try { await deleteDoc(doc(db, 'alunos', id)); } catch {}
  renderStudents(); checkLimit(); showToast(`‚úÖ ${nome} removido.`, 'success');
};

function renderStudents() {
  const arr = Object.entries(students).sort((a,b) => {
    const na = parseInt(a[1].num)||999, nb = parseInt(b[1].num)||999;
    return na !== nb ? na - nb : a[1].name.localeCompare(b[1].name);
  });
  updateStudentSelect(arr);
  const list = document.getElementById('studentList');
  if (!arr.length) { list.innerHTML = '<div class="empty-state"><p>Nenhum participante cadastrado.</p></div>'; updateStats(); return; }
  list.innerHTML = arr.map(([id,s]) => {
    const pts = Object.values(pointsData).filter(p => p.author === s.name).length;
    const ini = s.name.split(' ').slice(0,2).map(w=>w[0]).join('').toUpperCase();
    const isProf = s.tipo === 'professor';
    const avatarBg = isProf ? 'background:linear-gradient(135deg,#3d6b4f,#2f5340)' : 'background:linear-gradient(135deg,var(--sepia),var(--rust))';
    const subInfo = isProf ? (s.disciplina||'Professor') : (s.num?'N¬∫ '+s.num+' ¬∑ ':'')+( s.turma||'‚Äî');
    const badge = isProf
      ? `<span style="background:rgba(61,107,79,0.12);color:#3d6b4f;font-size:0.65rem;font-weight:600;padding:2px 7px;border-radius:20px;flex-shrink:0">üë®‚Äçüè´ Prof.</span>`
      : `<span class="student-pts ${pts===0?'zero':''}">${pts} pt${pts!==1?'s':''}</span>`;
    return `<div class="student-card" style="${isProf?'border-color:rgba(61,107,79,0.3);background:rgba(61,107,79,0.03)':''}">
      <div class="student-avatar" style="${avatarBg}">${ini}</div>
      <div class="student-info">
        <div class="student-name">${s.name}</div>
        <div class="student-sub">${subInfo}</div>
      </div>
      ${badge}
      <button class="student-del" onclick="deleteStudentAuth('${id}','${s.name.replace(/'/g,'\'')}')" title="Remover (requer senha)">üîí</button>
    </div>`;
  }).join('');
  renderRanking(arr);
  updateStats();
}

function updateStudentSelect(arr) {
  const sel = document.getElementById('authorSelect');
  const cur = sel.value;
  sel.innerHTML = '<option value="">Selecionar aluno...</option>';
  (arr || Object.entries(students)).forEach(([,s]) => {
    const o = document.createElement('option');
    o.value = s.name;
    o.textContent = s.name + (s.turma ? ' ('+s.turma+')' : '');
    sel.appendChild(o);
  });
  if (cur) sel.value = cur;
}

function renderRanking(arr) {
  if (!arr || arr.length === 0) { document.getElementById('rankingSection').style.display='none'; return; }
  document.getElementById('rankingSection').style.display = 'block';
  const top = arr.map(([,s]) => ({ name:s.name, pts:Object.values(pointsData).filter(p=>p.author===s.name).length }))
    .sort((a,b) => b.pts - a.pts).slice(0,8);
  const max = Math.max(...top.map(s=>s.pts), 1);
  document.getElementById('rankingList').innerHTML = top.map((s,i) => `
    <div class="ranking-row">
      <div class="r-pos">${i+1}¬∫</div>
      <div class="r-name">${s.name.split(' ')[0]}</div>
      <div class="r-bar-wrap"><div class="r-bar" style="width:${Math.round(s.pts/max*100)}%"></div></div>
      <div class="r-count">${s.pts}</div>
    </div>`).join('');
}

function updateStats() {
  const aArr = Object.values(students);
  const pArr = Object.values(pointsData);
  document.getElementById('statAlunos').textContent = aArr.length;
  document.getElementById('statPontos').textContent = pArr.length;
  document.getElementById('statParticip').textContent = aArr.filter(s => pArr.some(p=>p.author===s.name)).length;
}

// ===== PDF =====
document.getElementById('btnPDF').addEventListener('click', () => {
  const arr = Object.values(students).sort((a,b) => { const na=parseInt(a.num)||999,nb=parseInt(b.num)||999; return na!==nb?na-nb:a.name.localeCompare(b.name); });
  const pts = Object.values(pointsData);
  const hoje = new Date().toLocaleDateString('pt-BR',{day:'2-digit',month:'long',year:'numeric'});
  const rankTop = arr.map(s=>({name:s.name,pts:pts.filter(p=>p.author===s.name).length}))
    .sort((a,b)=>b.pts-a.pts).filter(s=>s.pts>0).slice(0,5)
    .map((s,i)=>`<tr><td style="padding:7px 14px;font-weight:700;color:#c4933a">${i+1}¬∫</td><td style="padding:7px 14px;font-weight:500">${s.name}</td><td style="padding:7px 14px;text-align:center;font-weight:700;color:#b5451b">${s.pts}</td></tr>`).join('');
  const tableRows = arr.map(s => {
    const n = pts.filter(p=>p.author===s.name).length;
    const pList = pts.filter(p=>p.author===s.name).map(p=>`<span style="font-size:11px;background:#f5edd6;padding:2px 7px;border-radius:10px;margin:2px;display:inline-block">${p.name}</span>`).join('');
    return `<tr style="border-bottom:1px solid #e8dcc8;">
      <td style="padding:8px 12px;font-size:13px">${s.num||'‚Äî'}</td>
      <td style="padding:8px 12px;font-size:13px;font-weight:500">${s.name}</td>
      <td style="padding:8px 12px;font-size:13px">${s.turma||'‚Äî'}</td>
      <td style="padding:8px 12px;text-align:center;font-weight:700;color:${n>0?'#b5451b':'#bbb'};font-size:13px">${n}</td>
      <td style="padding:8px 12px">${pList||'<span style="color:#bbb;font-size:11px">‚Äî</span>'}</td>
    </tr>`;
  }).join('');
  const html = `<!DOCTYPE html><html><head><meta charset="UTF-8">
  <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@700&family=DM+Sans:wght@400;500&display=swap" rel="stylesheet">
  <style>body{font-family:'DM Sans',sans-serif;color:#1a1208;padding:40px;max-width:960px;margin:0 auto;}
  h1{font-family:'Playfair Display',serif;font-size:2rem;margin-bottom:4px;}
  h2{font-family:'Playfair Display',serif;font-size:1.15rem;color:#b5451b;margin:28px 0 12px;border-bottom:2px solid #f5edd6;padding-bottom:6px;}
  .sub{color:#999;font-size:.9rem;margin-bottom:28px;}
  .stats{display:flex;gap:16px;margin-bottom:28px;}
  .sbox{background:#f5edd6;border-radius:10px;padding:16px 24px;text-align:center;flex:1;}
  .snum{font-family:'Playfair Display',serif;font-size:2rem;font-weight:700;color:#b5451b;}
  .slbl{font-size:.72rem;color:#999;text-transform:uppercase;letter-spacing:.06em;}
  table{width:100%;border-collapse:collapse;}
  thead{background:#1a1208;color:#f5edd6;}
  thead th{padding:10px 12px;font-size:12px;text-transform:uppercase;letter-spacing:.05em;font-weight:500;text-align:left;}
  .print-btn{float:right;background:#b5451b;color:white;border:none;padding:10px 20px;border-radius:8px;cursor:pointer;font-size:14px;font-weight:500;}
  @media print{.print-btn{display:none}}</style></head><body>
  <button class="print-btn" onclick="window.print()">üñ®Ô∏è Imprimir / Salvar PDF</button>
  <h1>PK Explorer</h1>
  <p class="sub">Relat√≥rio da Eletiva ¬∑ ${hoje}</p>
  <div class="stats">
    <div class="sbox"><div class="snum">${arr.length}</div><div class="slbl">Alunos</div></div>
    <div class="sbox"><div class="snum">${pts.length}</div><div class="slbl">Pontos</div></div>
    <div class="sbox"><div class="snum">${arr.filter(s=>pts.some(p=>p.author===s.name)).length}</div><div class="slbl">Participaram</div></div>
    <div class="sbox"><div class="snum">${arr.filter(s=>!pts.some(p=>p.author===s.name)).length}</div><div class="slbl">Sem registro</div></div>
  </div>
  ${rankTop?`<h2>üèÜ Top 5</h2><table><thead><tr><th>Pos.</th><th>Aluno</th><th>Pontos</th></tr></thead><tbody>${rankTop}</tbody></table>`:''}
  <h2>üìã Lista completa</h2>
  <table><thead><tr><th>N¬∫</th><th>Nome</th><th>Turma</th><th>Pontos</th><th>Locais cadastrados</th></tr></thead>
  <tbody>${tableRows}</tbody></table>
  </body></html>`;
  const win = window.open('','_blank'); win.document.write(html); win.document.close();
});

// ===== FIREBASE LISTENERS =====
const qP = query(collection(db, 'pontos'), orderBy('createdAt', 'desc'));
onSnapshot(qP, snap => {
  document.getElementById('statusDot').style.cssText = 'background:#4caf50;box-shadow:0 0 8px #4caf50';
  document.getElementById('statusLabel').textContent = 'Tempo real ativo';
  snap.docChanges().forEach(c => {
    if (c.type === 'added' || c.type === 'modified') renderPoint(c.doc.id, c.doc.data());
  });
}, () => {
  document.getElementById('statusDot').style.background = '#b5451b';
  document.getElementById('statusLabel').textContent = 'Erro de conex√£o';
});

onSnapshot(collection(db, 'alunos'), snap => {
  snap.docChanges().forEach(c => {
    if (c.type === 'added' || c.type === 'modified') students[c.doc.id] = c.doc.data();
    else if (c.type === 'removed') delete students[c.doc.id];
  });
  renderStudents();
  checkLimit();
});

</script>
</body>
</html>
