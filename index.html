<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>PK Explorer ‚Äî Pontos Geohist√≥ricos</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.css">
<link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@700;900&family=DM+Sans:wght@300;400;500&display=swap" rel="stylesheet">
<style>
  :root{--ink:#1a1208;--parchment:#f5edd6;--sepia:#c4933a;--rust:#b5451b;--moss:#3d6b4f;--cream:#faf4e8;--shadow:rgba(26,18,8,0.18);}
  *{margin:0;padding:0;box-sizing:border-box;}
  body{font-family:'DM Sans',sans-serif;background:var(--cream);color:var(--ink);min-height:100vh;overflow-x:hidden;}
  header{background:var(--ink);padding:0 24px;display:flex;align-items:center;justify-content:space-between;height:64px;position:fixed;top:0;left:0;right:0;z-index:1000;box-shadow:0 2px 20px rgba(0,0,0,0.4);}
  .logo{font-family:'Playfair Display',serif;font-size:1.4rem;font-weight:900;color:var(--sepia);}
  .logo span{color:var(--parchment);font-weight:700;}
  .header-right{display:flex;align-items:center;gap:12px;}
  .status-dot{width:8px;height:8px;border-radius:50%;background:#4caf50;box-shadow:0 0 8px #4caf50;animation:pulse-dot 2s infinite;}
  @keyframes pulse-dot{0%,100%{opacity:1}50%{opacity:0.4}}
  .status-label{font-size:0.75rem;color:rgba(255,255,255,0.5);font-weight:300;}
  .app{padding-top:64px;display:grid;grid-template-columns:410px 1fr;height:100vh;}
  .sidebar{background:var(--parchment);border-right:1px solid rgba(196,147,58,0.3);display:flex;flex-direction:column;overflow:hidden;position:relative;}
  .sidebar::before{content:'';position:absolute;top:0;left:0;right:0;height:3px;background:linear-gradient(90deg,var(--sepia),var(--rust),var(--moss));}
  .sidebar-tabs{display:flex;border-bottom:1px solid rgba(196,147,58,0.2);overflow-x:auto;}
  .tab-btn{flex:1;min-width:75px;padding:13px 4px;font-family:'DM Sans',sans-serif;font-size:0.72rem;font-weight:500;background:none;border:none;cursor:pointer;color:rgba(26,18,8,0.45);border-bottom:2px solid transparent;transition:all 0.2s;margin-bottom:-1px;white-space:nowrap;}
  .tab-btn.active{color:var(--rust);border-bottom-color:var(--rust);}
  .tab-panel{display:none;flex:1;overflow-y:auto;}
  .tab-panel.active{display:flex;flex-direction:column;}
  .form-area{padding:18px 22px;}
  .form-group{margin-bottom:13px;}
  label{display:block;font-size:0.7rem;font-weight:500;text-transform:uppercase;letter-spacing:0.08em;color:rgba(26,18,8,0.5);margin-bottom:5px;}
  input,textarea,select{width:100%;background:white;border:1.5px solid rgba(196,147,58,0.3);border-radius:8px;padding:9px 13px;font-family:'DM Sans',sans-serif;font-size:0.87rem;color:var(--ink);transition:border-color 0.2s,box-shadow 0.2s;outline:none;}
  input:focus,textarea:focus,select:focus{border-color:var(--sepia);box-shadow:0 0 0 3px rgba(196,147,58,0.15);}
  textarea{resize:vertical;min-height:70px;line-height:1.5;}
  select{appearance:none;background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='8' viewBox='0 0 12 8'%3E%3Cpath d='M1 1l5 5 5-5' stroke='%23c4933a' fill='none' stroke-width='2'/%3E%3C/svg%3E");background-repeat:no-repeat;background-position:right 13px center;cursor:pointer;}
  .gps-row{display:grid;grid-template-columns:1fr 1fr;gap:8px;}
  .gps-btn{grid-column:1/-1;display:flex;align-items:center;justify-content:center;gap:8px;background:var(--moss);color:white;border:none;border-radius:8px;padding:10px 14px;font-family:'DM Sans',sans-serif;font-size:0.82rem;font-weight:500;cursor:pointer;transition:background 0.2s;}
  .gps-btn:hover{background:#2f5340;}
  .media-tabs{display:flex;gap:6px;margin-bottom:10px;flex-wrap:wrap;}
  .media-tab-btn{display:flex;align-items:center;gap:5px;padding:6px 12px;border-radius:20px;border:1.5px solid rgba(196,147,58,0.3);background:white;font-family:'DM Sans',sans-serif;font-size:0.75rem;font-weight:500;cursor:pointer;color:rgba(26,18,8,0.55);transition:all 0.2s;}
  .media-tab-btn:hover{border-color:var(--sepia);color:var(--sepia);}
  .media-tab-btn.active{background:var(--sepia);border-color:var(--sepia);color:white;}
  .media-upload-area{border:2px dashed rgba(196,147,58,0.35);border-radius:10px;padding:14px;text-align:center;cursor:pointer;transition:all 0.2s;background:white;display:none;}
  .media-upload-area:hover{border-color:var(--sepia);background:rgba(196,147,58,0.05);}
  .media-upload-area p{font-size:0.76rem;color:rgba(26,18,8,0.45);margin-top:5px;}
  .media-upload-area input[type=file]{display:none;}
  .media-preview{display:flex;flex-wrap:wrap;gap:8px;margin-top:8px;}
  .media-thumb{position:relative;width:68px;height:68px;border-radius:8px;overflow:hidden;border:1.5px solid rgba(196,147,58,0.3);background:#f0e8d0;}
  .media-thumb img,.media-thumb video{width:100%;height:100%;object-fit:cover;}
  .media-thumb .remove-btn{position:absolute;top:2px;right:2px;width:18px;height:18px;border-radius:50%;background:rgba(181,69,27,0.9);color:white;border:none;cursor:pointer;font-size:10px;display:flex;align-items:center;justify-content:center;}
  .audio-recorder{padding:12px;background:white;border-radius:10px;border:1.5px solid rgba(196,147,58,0.3);}
  .recorder-controls{display:flex;align-items:center;gap:10px;flex-wrap:wrap;}
  .rec-btn{display:flex;align-items:center;gap:6px;padding:8px 14px;border-radius:20px;border:none;font-family:'DM Sans',sans-serif;font-size:0.8rem;font-weight:500;cursor:pointer;transition:all 0.2s;}
  .rec-btn.record{background:#ef4444;color:white;}
  .rec-btn.stop{background:#6b7280;color:white;}
  .rec-btn:disabled{opacity:0.4;cursor:not-allowed;}
  .rec-timer{font-size:0.82rem;font-weight:500;font-variant-numeric:tabular-nums;}
  .rec-dot{width:8px;height:8px;border-radius:50%;background:#ef4444;animation:pulse-dot 1s infinite;}
  .audio-list{margin-top:10px;display:flex;flex-direction:column;gap:6px;}
  .audio-item{display:flex;align-items:center;gap:8px;padding:8px 12px;background:rgba(196,147,58,0.08);border-radius:8px;border:1px solid rgba(196,147,58,0.2);}
  .audio-item audio{flex:1;height:32px;}
  .audio-item .remove-btn{width:22px;height:22px;border-radius:50%;background:var(--rust);color:white;border:none;cursor:pointer;font-size:11px;display:flex;align-items:center;justify-content:center;flex-shrink:0;}
  .submit-btn{width:100%;background:var(--rust);color:white;border:none;border-radius:8px;padding:13px;font-family:'Playfair Display',serif;font-size:1rem;font-weight:700;cursor:pointer;transition:background 0.2s,box-shadow 0.2s;letter-spacing:0.02em;margin-top:4px;}
  .submit-btn:hover{background:#963c17;box-shadow:0 4px 16px rgba(181,69,27,0.35);}
  .submit-btn:disabled{background:#ccc;cursor:not-allowed;box-shadow:none;}
  .points-list-area{flex:1;overflow-y:auto;padding:16px 22px;}
  .list-header{font-family:'Playfair Display',serif;font-size:1rem;font-weight:700;margin-bottom:12px;display:flex;align-items:center;gap:8px;}
  .count-badge{background:var(--sepia);color:white;font-family:'DM Sans',sans-serif;font-size:0.72rem;font-weight:500;padding:2px 8px;border-radius:20px;}
  .point-card{background:white;border-radius:10px;padding:12px 14px;margin-bottom:8px;border-left:3px solid var(--sepia);box-shadow:0 2px 8px var(--shadow);cursor:pointer;transition:transform 0.15s,box-shadow 0.15s;animation:slide-in 0.3s ease;}
  @keyframes slide-in{from{opacity:0;transform:translateY(-8px)}to{opacity:1;transform:translateY(0)}}
  .point-card:hover{transform:translateX(3px);box-shadow:0 4px 16px var(--shadow);}
  .point-card.pending{border-left-color:#e6a817;}
  .point-card.aprovado{border-left-color:var(--moss);}
  .point-title{font-weight:500;font-size:0.88rem;margin-bottom:4px;}
  .point-meta{font-size:0.73rem;color:rgba(26,18,8,0.5);display:flex;gap:8px;align-items:center;flex-wrap:wrap;}
  .category-tag{background:rgba(196,147,58,0.15);color:var(--sepia);font-size:0.66rem;font-weight:500;padding:2px 7px;border-radius:20px;text-transform:uppercase;letter-spacing:0.05em;}
  .status-tag{font-size:0.66rem;font-weight:500;padding:2px 7px;border-radius:20px;text-transform:uppercase;letter-spacing:0.05em;}
  .status-tag.pending{background:rgba(230,168,23,0.15);color:#c49010;}
  .status-tag.aprovado{background:rgba(61,107,79,0.15);color:var(--moss);}
  .point-media-icons{display:flex;gap:4px;margin-top:4px;}
  .media-icon-badge{font-size:0.68rem;background:rgba(26,18,8,0.07);padding:1px 6px;border-radius:10px;}

  /* ===== ABA ALUNOS ===== */
  .students-area{padding:18px 22px;display:flex;flex-direction:column;gap:14px;flex:1;overflow-y:auto;}
  .students-header{display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;gap:8px;}
  .students-title{font-family:'Playfair Display',serif;font-size:1.05rem;font-weight:700;}
  .students-actions{display:flex;gap:8px;}
  .btn-sm{display:flex;align-items:center;gap:5px;padding:7px 12px;border-radius:8px;border:none;font-family:'DM Sans',sans-serif;font-size:0.76rem;font-weight:500;cursor:pointer;transition:all 0.2s;}
  .btn-sm.primary{background:var(--rust);color:white;}
  .btn-sm.primary:hover{background:#963c17;}
  .btn-sm.secondary{background:var(--moss);color:white;}
  .btn-sm.secondary:hover{background:#2f5340;}
  .btn-sm.outline{background:white;color:var(--sepia);border:1.5px solid rgba(196,147,58,0.4);}
  .btn-sm.outline:hover{background:rgba(196,147,58,0.08);}
  .report-stats{display:grid;grid-template-columns:repeat(3,1fr);gap:8px;}
  .stat-box{background:white;border-radius:10px;padding:12px;text-align:center;border:1.5px solid rgba(196,147,58,0.2);}
  .stat-num{font-family:'Playfair Display',serif;font-size:1.5rem;font-weight:700;color:var(--rust);}
  .stat-lbl{font-size:0.66rem;color:rgba(26,18,8,0.45);text-transform:uppercase;letter-spacing:0.05em;}
  .add-student-form{background:white;border-radius:10px;padding:14px;border:1.5px solid rgba(196,147,58,0.25);display:none;}
  .add-student-form.open{display:block;}
  .add-student-row{display:grid;grid-template-columns:1fr 1fr;gap:8px;}
  .add-student-row .full{grid-column:1/-1;}
  .student-list-wrap{display:flex;flex-direction:column;gap:6px;}
  .student-card{background:white;border-radius:10px;padding:11px 14px;border:1.5px solid rgba(196,147,58,0.2);display:flex;align-items:center;gap:10px;transition:box-shadow 0.15s;}
  .student-card:hover{box-shadow:0 2px 12px var(--shadow);}
  .student-avatar{width:36px;height:36px;border-radius:50%;background:linear-gradient(135deg,var(--sepia),var(--rust));display:flex;align-items:center;justify-content:center;color:white;font-weight:700;font-size:0.82rem;flex-shrink:0;}
  .student-info{flex:1;min-width:0;}
  .student-name{font-weight:500;font-size:0.86rem;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
  .student-sub{font-size:0.71rem;color:rgba(26,18,8,0.45);}
  .student-pts{background:var(--sepia);color:white;font-size:0.72rem;font-weight:700;padding:3px 8px;border-radius:20px;flex-shrink:0;}
  .student-pts.zero{background:rgba(26,18,8,0.1);color:rgba(26,18,8,0.4);}
  .student-del{width:24px;height:24px;border-radius:50%;background:rgba(181,69,27,0.1);border:none;cursor:pointer;color:var(--rust);font-size:13px;display:flex;align-items:center;justify-content:center;flex-shrink:0;transition:background 0.15s;}
  .student-del:hover{background:rgba(181,69,27,0.2);}
  .ranking-section{background:white;border-radius:10px;padding:14px;border:1.5px solid rgba(196,147,58,0.2);}
  .section-label{font-size:0.7rem;font-weight:500;text-transform:uppercase;letter-spacing:0.08em;color:rgba(26,18,8,0.45);margin-bottom:10px;}
  .ranking-row{display:flex;align-items:center;gap:10px;padding:6px 0;border-bottom:1px solid rgba(196,147,58,0.1);}
  .ranking-row:last-child{border-bottom:none;}
  .r-pos{font-size:0.78rem;font-weight:700;width:20px;color:var(--sepia);}
  .r-name{flex:1;font-size:0.84rem;font-weight:500;}
  .r-bar-wrap{width:70px;background:rgba(196,147,58,0.12);border-radius:20px;height:6px;overflow:hidden;}
  .r-bar{height:100%;background:linear-gradient(90deg,var(--sepia),var(--rust));border-radius:20px;transition:width 0.6s ease;}
  .r-count{font-size:0.78rem;font-weight:700;color:var(--rust);width:22px;text-align:right;}

  /* MAP */
  #map{width:100%;height:100%;z-index:1;}

  /* MODAL */
  .modal-overlay{position:fixed;inset:0;background:rgba(0,0,0,0.7);z-index:3000;display:none;align-items:center;justify-content:center;padding:20px;}
  .modal-overlay.open{display:flex;}
  .modal{background:white;border-radius:16px;max-width:560px;width:100%;max-height:90vh;overflow-y:auto;box-shadow:0 20px 60px rgba(0,0,0,0.4);animation:modal-in 0.25s ease;}
  @keyframes modal-in{from{opacity:0;transform:scale(0.94)}to{opacity:1;transform:scale(1)}}
  .modal-header{padding:20px 24px 0;display:flex;justify-content:space-between;align-items:flex-start;}
  .modal-title{font-family:'Playfair Display',serif;font-size:1.2rem;font-weight:700;}
  .modal-cat{font-size:0.75rem;color:var(--sepia);font-weight:500;text-transform:uppercase;letter-spacing:0.06em;margin-top:3px;}
  .modal-close{background:none;border:none;cursor:pointer;color:rgba(26,18,8,0.4);font-size:1.4rem;line-height:1;padding:4px;}
  .modal-body{padding:16px 24px 24px;}
  .modal-desc{font-size:0.9rem;line-height:1.6;color:rgba(26,18,8,0.75);margin-bottom:12px;}
  .modal-author{font-size:0.78rem;color:rgba(26,18,8,0.4);margin-bottom:16px;}
  .modal-media-section{margin-bottom:14px;}
  .modal-media-label{font-size:0.72rem;font-weight:500;text-transform:uppercase;letter-spacing:0.07em;color:rgba(26,18,8,0.45);margin-bottom:8px;}
  .modal-photos{display:grid;grid-template-columns:repeat(auto-fill,minmax(110px,1fr));gap:8px;}
  .modal-photo{width:100%;aspect-ratio:1;object-fit:cover;border-radius:8px;cursor:pointer;transition:transform 0.15s;}
  .modal-photo:hover{transform:scale(1.03);}
  .modal-video{width:100%;border-radius:10px;margin-bottom:8px;}
  .modal-audio{width:100%;margin-bottom:8px;}
  .modal-text-note{background:rgba(196,147,58,0.08);border-left:3px solid var(--sepia);border-radius:0 8px 8px 0;padding:12px 14px;font-size:0.87rem;line-height:1.6;margin-bottom:8px;}

  /* LAYER CONTROL */
  .leaflet-control-layers{background:white !important;border:1.5px solid rgba(196,147,58,0.35) !important;border-radius:10px !important;box-shadow:0 4px 16px rgba(0,0,0,0.15) !important;font-family:'DM Sans',sans-serif !important;}
  .leaflet-control-layers-list{padding:6px 4px !important;}
  .leaflet-control-layers label{font-size:0.82rem !important;font-weight:500 !important;color:#1a1208 !important;padding:5px 10px !important;border-radius:6px !important;cursor:pointer !important;display:flex !important;align-items:center !important;gap:6px !important;transition:background 0.15s !important;text-transform:none !important;letter-spacing:normal !important;}
  .leaflet-control-layers label:hover{background:rgba(196,147,58,0.1) !important;}
  .leaflet-control-layers-selector{accent-color:#c4933a;margin-right:4px !important;}

  /* POPUP */
  .leaflet-popup-content-wrapper{border-radius:10px;box-shadow:0 4px 20px rgba(0,0,0,0.2);font-family:'DM Sans',sans-serif;}
  .popup-open-btn{display:inline-flex;align-items:center;gap:5px;margin-top:10px;padding:7px 14px;background:var(--rust);color:white;border:none;border-radius:20px;font-family:'DM Sans',sans-serif;font-size:0.78rem;font-weight:500;cursor:pointer;transition:background 0.2s;}
  .popup-open-btn:hover{background:#963c17;}
  .popup-title{font-family:'Playfair Display',serif;font-size:1rem;font-weight:700;color:var(--ink);margin-bottom:4px;}
  .popup-cat{font-size:0.72rem;font-weight:500;text-transform:uppercase;letter-spacing:0.05em;color:var(--sepia);margin-bottom:6px;}
  .popup-desc{font-size:0.82rem;color:rgba(26,18,8,0.7);line-height:1.5;margin-bottom:6px;}
  .popup-author{font-size:0.72rem;color:rgba(26,18,8,0.4);}
  .popup-media-row{display:flex;gap:6px;margin-top:8px;flex-wrap:wrap;}
  .popup-media-badge{font-size:0.72rem;background:rgba(196,147,58,0.12);padding:3px 8px;border-radius:10px;color:var(--sepia);font-weight:500;}

  .toast{position:fixed;bottom:24px;right:24px;background:var(--ink);color:var(--parchment);padding:13px 18px;border-radius:10px;font-size:0.84rem;z-index:9999;transform:translateY(100px);opacity:0;transition:transform 0.3s,opacity 0.3s;max-width:300px;box-shadow:0 8px 32px rgba(0,0,0,0.3);border-left:3px solid var(--sepia);}
  .toast.show{transform:translateY(0);opacity:1;}
  .toast.success{border-left-color:var(--moss);}
  .toast.error{border-left-color:var(--rust);}
  .empty-state{text-align:center;padding:24px 16px;color:rgba(26,18,8,0.35);}
  .empty-state p{font-size:0.84rem;line-height:1.5;}
  ::-webkit-scrollbar{width:4px;}
  ::-webkit-scrollbar-thumb{background:rgba(196,147,58,0.3);border-radius:4px;}
  .loading{display:inline-block;width:16px;height:16px;border:2px solid rgba(255,255,255,0.3);border-top-color:white;border-radius:50%;animation:spin 0.7s linear infinite;}
  @keyframes spin{to{transform:rotate(360deg)}}
  @media(max-width:768px){
    .app{grid-template-columns:1fr;grid-template-rows:auto 1fr;}
    .sidebar{max-height:55vh;border-right:none;border-bottom:1px solid rgba(196,147,58,0.3);}
    #map{height:45vh;}
  }
</style>
</head>
<body>

<header>
  <div class="logo">PK <span>Explorer</span></div>
  <div class="header-right">
    <div class="status-dot" id="statusDot"></div>
    <span class="status-label" id="statusLabel">Conectando...</span>
  </div>
</header>

<div class="app">
  <div class="sidebar">
    <div class="sidebar-tabs" style="padding-top:4px;">
      <button class="tab-btn active" data-action="switchTab" data-arg="form">‚úèÔ∏è Registrar</button>
      <button class="tab-btn" data-action="switchTab" data-arg="list">üìç Pontos</button>
      <button class="tab-btn" data-action="switchTab" data-arg="students">üë• Alunos/Eletiva</button>
    </div>

    <!-- ===== TAB REGISTRAR ===== -->
    <div class="tab-panel active" id="tab-form">
      <div class="form-area">
        <div class="form-group">
          <label>Aluno respons√°vel</label>
          <select id="authorSelect"><option value="">Selecionar aluno...</option></select>
        </div>
        <div class="form-group">
          <label>Nome do ponto hist√≥rico</label>
          <input type="text" id="pointName" placeholder="Ex: Casar√£o da Fam√≠lia Ferreira">
        </div>
        <div class="form-group">
          <label>Categoria</label>
          <select id="category">
            <option value="">Selecionar...</option>
            <option value="Arquitetura">üèõÔ∏è Arquitetura</option>
            <option value="Conflito">‚öîÔ∏è Conflito / Revolu√ß√£o</option>
            <option value="Cultura">üé≠ Cultura e Arte</option>
            <option value="Economia">üí∞ Economia</option>
            <option value="Marco Geogr√°fico">üó∫Ô∏è Marco Geogr√°fico</option>
            <option value="Personalidade">üë§ Personalidade Hist√≥rica</option>
            <option value="Religi√£o">‚õ™ Religi√£o</option>
            <option value="Natureza">üåø Natureza</option>
            <option value="Outro">üìå Outro</option>
          </select>
        </div>
        <div class="form-group">
          <label>Descri√ß√£o hist√≥rica</label>
          <textarea id="description" placeholder="Descreva o significado hist√≥rico deste lugar..."></textarea>
        </div>
        <div class="form-group">
          <label>M√≠dias</label>
          <div class="media-tabs">
            <button class="media-tab-btn" id="mtb-photos" data-action="toggleMediaTab" data-arg="photos">üì∑ Fotos</button>
            <button class="media-tab-btn" id="mtb-videos" data-action="toggleMediaTab" data-arg="videos">üé¨ V√≠deos</button>
            <button class="media-tab-btn" id="mtb-audio" data-action="toggleMediaTab" data-arg="audio">üéôÔ∏è √Åudio</button>
            <button class="media-tab-btn" id="mtb-texts" data-action="toggleMediaTab" data-arg="texts">üìù Nota</button>
          </div>
          <div class="media-upload-area" id="mup-photos" data-action="triggerPhoto">
            <div style="font-size:1.8rem">üì∑</div>
            <p>Toque para selecionar fotos<br><small style="opacity:.6">JPG, PNG ‚Äî m√∫ltiplas</small></p>
            <input type="file" id="photoInput" accept="image/*" multiple data-filetype="photo">
          </div>
          <div class="media-upload-area" id="mup-videos" data-action="triggerVideo">
            <div style="font-size:1.8rem">üé¨</div>
            <p>Toque para selecionar v√≠deos<br><small style="opacity:.6">MP4, MOV</small></p>
            <input type="file" id="videoInput" accept="video/*" multiple data-filetype="video">
          </div>
          <div class="media-upload-area" id="mup-audio-panel" style="display:none;cursor:default;">
            <div class="audio-recorder">
              <div class="recorder-controls">
                <button class="rec-btn record" id="recStartBtn" data-action="startRecording">‚è∫ Gravar</button>
                <button class="rec-btn stop" id="recStopBtn" data-action="stopRecording" disabled>‚èπ Parar</button>
                <span class="rec-timer" id="recTimer">00:00</span>
                <span class="rec-dot" id="recDot" style="display:none"></span>
              </div>
              <div class="audio-list" id="audioList"></div>
            </div>
          </div>
          <div class="media-upload-area" id="mup-texts" style="cursor:default;">
            <div style="font-size:1.8rem">üìù</div>
            <p style="margin-bottom:8px">Anota√ß√µes e fontes</p>
            <textarea id="extraText" placeholder="Ex: Segundo o livro X..." style="text-align:left;cursor:text" onclick="event.stopPropagation()"></textarea>
          </div>
          <div class="media-preview" id="mediaPreview"></div>
        </div>
        <div class="form-group">
          <label>Localiza√ß√£o</label>
          <div class="gps-row">
            <input type="number" id="lat" placeholder="Latitude" step="any" readonly>
            <input type="number" id="lng" placeholder="Longitude" step="any" readonly>
            <button class="gps-btn" data-action="getGPS">
              <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><circle cx="12" cy="12" r="3"/><path d="M12 2v4M12 18v4M2 12h4M18 12h4"/></svg>
              Usar minha localiza√ß√£o atual
            </button>
          </div>
        </div>
        <button class="submit-btn" id="submitBtn" data-action="submitPoint">Registrar Ponto Hist√≥rico</button>
      </div>
    </div>

    <!-- ===== TAB PONTOS ===== -->
    <div class="tab-panel" id="tab-list">
      <div class="points-list-area">
        <div class="list-header">Pontos registrados <span class="count-badge" id="countBadge">0</span></div>
        <div id="pointsList"><div class="empty-state"><p>Nenhum ponto cadastrado ainda.</p></div></div>
      </div>
    </div>

    <!-- ===== TAB ALUNOS/ELETIVA ===== -->
    <div class="tab-panel" id="tab-students">
      <div class="students-area">

        <div class="students-header">
          <div class="students-title">üë• Alunos / Eletiva</div>
          <div class="students-actions">
            <button class="btn-sm outline" data-action="toggleAddForm">+ Aluno</button>
            <button class="btn-sm secondary" data-action="gerarPDF">üìÑ Relat√≥rio PDF</button>
          </div>
        </div>

        <!-- Stats r√°pidos -->
        <div class="report-stats">
          <div class="stat-box"><div class="stat-num" id="statAlunos">0</div><div class="stat-lbl">Alunos</div></div>
          <div class="stat-box"><div class="stat-num" id="statPontos">0</div><div class="stat-lbl">Pontos</div></div>
          <div class="stat-box"><div class="stat-num" id="statParticip">0</div><div class="stat-lbl">Participaram</div></div>
        </div>

        <!-- Form novo aluno -->
        <div class="add-student-form" id="addStudentForm">
          <div class="add-student-row" style="margin-bottom:10px">
            <div class="full form-group" style="margin-bottom:10px">
              <label>Nome completo *</label>
              <input type="text" id="sName" placeholder="Nome do aluno">
            </div>
            <div class="form-group" style="margin-bottom:0">
              <label>Turma</label>
              <input type="text" id="sTurma" placeholder="Ex: 9¬∫A">
            </div>
            <div class="form-group" style="margin-bottom:0">
              <label>N√∫mero</label>
              <input type="number" id="sNum" placeholder="01" min="1" max="50">
            </div>
          </div>
          <div style="display:flex;gap:8px">
            <button class="btn-sm primary" data-action="addStudent" style="flex:1">Salvar aluno</button>
            <button class="btn-sm outline" data-action="toggleAddForm">Cancelar</button>
          </div>
        </div>

        <!-- Ranking -->
        <div class="ranking-section" id="rankingSection" style="display:none">
          <div class="section-label">üèÜ Ranking de cadastros</div>
          <div id="rankingList"></div>
        </div>

        <!-- Lista alunos -->
        <div class="student-list-wrap" id="studentList">
          <div class="empty-state"><p>Nenhum aluno cadastrado.<br>Clique em "+ Aluno" para come√ßar.</p></div>
        </div>

      </div>
    </div>

  </div><!-- /sidebar -->

  <div id="map"></div>
</div>

<!-- MODAL PONTO -->
<div class="modal-overlay" id="modalOverlay">
  <div class="modal">
    <div class="modal-header">
      <div><div class="modal-title" id="modalTitle"></div><div class="modal-cat" id="modalCat"></div></div>
      <button class="modal-close" data-action="closeModalDirect">√ó</button>
    </div>
    <div class="modal-body" id="modalBody"></div>
  </div>
</div>

<div class="toast" id="toast"></div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.js"></script>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-app.js";
  import { getFirestore, collection, addDoc, onSnapshot, serverTimestamp, query, orderBy, doc, setDoc, deleteDoc } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-firestore.js";
  import { getStorage, ref as sRef, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-storage.js";

  // ============================================================
  // üîß CONFIGURA√á√ÉO FIREBASE ‚Äî substitua pelos seus dados!
  // ============================================================
  const firebaseConfig = {
    apiKey: "AIzaSyAw3_toa8iNQEHv_NostV1wt0t2lqHcoqg",
    authDomain: "pk-explorer.firebaseapp.com",
    databaseURL: "https://pk-explorer-default-rtdb.firebaseio.com",
    projectId: "pk-explorer",
    storageBucket: "pk-explorer.firebasestorage.app",
    messagingSenderId: "731000410555",
    appId: "1:731000410555:web:d715162b1bb96787f1349e"
  };
  // ============================================================

  const DEMO_MODE = firebaseConfig.apiKey === "SUA_API_KEY";
  let fbApp, db, storage;
  if (!DEMO_MODE) { fbApp = initializeApp(firebaseConfig); db = getFirestore(fbApp); storage = getStorage(fbApp); }

  // ===== MAPA ‚Äî maxNativeZoom CORRIGE TELA BRANCA =====
  const map = L.map('map', { zoomControl: false }).setView([-15.78, -47.93], 13);
  L.control.zoom({ position: 'bottomright' }).addTo(map);

  const layerRua = L.tileLayer('https://{s}.basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}{r}.png', {
    attribution: '¬© OpenStreetMap ¬© CARTO', maxZoom: 21, maxNativeZoom: 19
  });
  const layerSatelite = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
    attribution: '¬© Esri', maxZoom: 21, maxNativeZoom: 19
  });
  const layerRelevo = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Topo_Map/MapServer/tile/{z}/{y}/{x}', {
    attribution: '¬© Esri', maxZoom: 21, maxNativeZoom: 19
  });
  layerRua.addTo(map);
  L.control.layers({ "üó∫Ô∏è Rua": layerRua, "üõ∞Ô∏è Sat√©lite": layerSatelite, "‚õ∞Ô∏è Relevo": layerRelevo }, {}, { position: 'topright', collapsed: false }).addTo(map);

  // ===== ESTADO =====
  let mediaFiles = { photo: [], video: [] }, audioBlobs = [];
  let mediaRecorder = null, recChunks = [], recInterval = null, recSeconds = 0;
  let pointsData = {}, students = {}, activeMediaTab = null;
  const markers = {};
  let activeMarkerKey = null;

  // ===== TABS =====
  window.switchTab = function(tab) {
    ['form','list','students'].forEach((t,i) => {
      document.getElementById('tab-'+t).classList.toggle('active', t===tab);
      document.querySelectorAll('.tab-btn')[i].classList.toggle('active', t===tab);
    });
  };

  // ===== MEDIA TABS =====
  window.toggleMediaTab = function(tab) {
    const m = { photos:'mup-photos', videos:'mup-videos', audio:'mup-audio-panel', texts:'mup-texts' };
    if (activeMediaTab===tab) { document.getElementById(m[tab]).style.display='none'; document.getElementById('mtb-'+tab).classList.remove('active'); activeMediaTab=null; return; }
    Object.keys(m).forEach(k => { document.getElementById(m[k]).style.display='none'; document.getElementById('mtb-'+k).classList.remove('active'); });
    document.getElementById(m[tab]).style.display='block'; document.getElementById('mtb-'+tab).classList.add('active'); activeMediaTab=tab;
  };

  window.handleFiles = function(e, type) {
    Array.from(e.target.files).forEach(file => {
      mediaFiles[type].push(file);
      const thumb = document.createElement('div'); thumb.className='media-thumb';
      const el = type==='photo' ? document.createElement('img') : document.createElement('video');
      el.src = URL.createObjectURL(file); thumb.appendChild(el);
      const rm = document.createElement('button'); rm.className='remove-btn'; rm.textContent='√ó';
      const idx = mediaFiles[type].length-1; rm.onclick=()=>{ mediaFiles[type].splice(idx,1); thumb.remove(); };
      thumb.appendChild(rm); document.getElementById('mediaPreview').appendChild(thumb);
    });
  };

  // ===== √ÅUDIO =====
  window.startRecording = async function() {
    try {
      const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
      recChunks = []; mediaRecorder = new MediaRecorder(stream);
      mediaRecorder.ondataavailable = e => recChunks.push(e.data);
      mediaRecorder.onstop = () => {
        const blob = new Blob(recChunks, { type:'audio/webm' }); audioBlobs.push(blob);
        const url = URL.createObjectURL(blob); const idx = audioBlobs.length-1;
        const item = document.createElement('div'); item.className='audio-item';
        item.innerHTML=`<audio controls src="${url}"></audio>`;
        const rm = document.createElement('button'); rm.className='remove-btn'; rm.textContent='√ó';
        rm.onclick=()=>{ audioBlobs[idx]=null; item.remove(); };
        item.appendChild(rm); document.getElementById('audioList').appendChild(item);
        stream.getTracks().forEach(t=>t.stop()); showToast('üéôÔ∏è √Åudio gravado!','success');
      };
      mediaRecorder.start(); recSeconds=0;
      document.getElementById('recTimer').textContent='00:00';
      document.getElementById('recDot').style.display='inline-block';
      document.getElementById('recStartBtn').disabled=true; document.getElementById('recStopBtn').disabled=false;
      recInterval=setInterval(()=>{ recSeconds++; document.getElementById('recTimer').textContent=String(Math.floor(recSeconds/60)).padStart(2,'0')+':'+String(recSeconds%60).padStart(2,'0'); },1000);
    } catch { showToast('Sem acesso ao microfone.','error'); }
  };
  window.stopRecording = function() {
    if (mediaRecorder?.state!=='inactive') { mediaRecorder.stop(); clearInterval(recInterval); document.getElementById('recDot').style.display='none'; document.getElementById('recStartBtn').disabled=false; document.getElementById('recStopBtn').disabled=true; }
  };

  // ===== √çCONE MAPA =====
  function createIcon(status, big=false) {
    const color = status==='aprovado'?'#3d6b4f':status==='pending'?'#e6a817':'#b5451b';
    const s = big?38:28;
    return L.divIcon({
      className:'',
      html:`<div style="position:relative;width:${s}px;height:${s+8}px"><div style="width:${s}px;height:${s}px;background:${color};border:3px solid white;border-radius:50% 50% 50% 0;transform:rotate(-45deg);box-shadow:0 ${big?6:2}px ${big?20:8}px rgba(0,0,0,${big?.45:.3})"></div><div style="position:absolute;bottom:0;left:50%;transform:translateX(-50%);width:${big?10:6}px;height:3px;background:rgba(0,0,0,0.2);border-radius:50%;filter:blur(2px)"></div></div>`,
      iconSize:[s,s+8], iconAnchor:[s/2,s+8], popupAnchor:[0,-(s+12)]
    });
  }
  function setActiveMarker(id) {
    if (activeMarkerKey && activeMarkerKey!==id && markers[activeMarkerKey]) markers[activeMarkerKey].setIcon(createIcon(markers[activeMarkerKey].options._status||'pending',false));
    activeMarkerKey=id;
  }

  // ===== MODAL =====
  window.openModal = function(id) {
    const d = pointsData[id]; if (!d) return;
    document.getElementById('modalTitle').textContent=d.name; document.getElementById('modalCat').textContent=d.category;
    let body=`<div class="modal-desc">${d.description||'Sem descri√ß√£o.'}</div><div class="modal-author">üìö ${d.author} ¬∑ ${d.status==='aprovado'?'‚úÖ Aprovado':'‚è≥ Pendente'}</div>`;
    if (d.photos?.length) { body+=`<div class="modal-media-section"><div class="modal-media-label">üì∑ Fotos</div><div class="modal-photos">`; d.photos.forEach(u=>{body+=`<img class="modal-photo" src="${u}" onclick="window.open('${u}','_blank')" loading="lazy">`;} ); body+=`</div></div>`; }
    if (d.videos?.length) { body+=`<div class="modal-media-section"><div class="modal-media-label">üé¨ V√≠deos</div>`; d.videos.forEach(u=>{body+=`<video class="modal-video" controls src="${u}"></video>`;} ); body+=`</div>`; }
    if (d.audios?.length) { body+=`<div class="modal-media-section"><div class="modal-media-label">üéôÔ∏è √Åudios</div>`; d.audios.forEach(u=>{body+=`<audio class="modal-audio" controls src="${u}"></audio>`;} ); body+=`</div>`; }
    if (d.extraText) body+=`<div class="modal-media-section"><div class="modal-media-label">üìù Anota√ß√µes</div><div class="modal-text-note">${d.extraText}</div></div>`;
    document.getElementById('modalBody').innerHTML=body; document.getElementById('modalOverlay').classList.add('open');
  };
  window.closeModal = e=>{ if(e.target===document.getElementById('modalOverlay')) closeModalDirect(); };
  window.closeModalDirect = ()=>document.getElementById('modalOverlay').classList.remove('open');

  // ===== RENDER PONTO =====
  function renderPoint(id, data) {
    pointsData[id]=data;
    if (!markers[id] && data.lat && data.lng) {
      const badges=[];
      if (data.photos?.length) badges.push(`üì∑ ${data.photos.length}`);
      if (data.videos?.length) badges.push(`üé¨ ${data.videos.length}`);
      if (data.audios?.length) badges.push(`üéôÔ∏è ${data.audios.length}`);
      if (data.extraText) badges.push('üìù');
      const popup = L.popup({ autoPan:false, autopanOnFocus:false }).setContent(`
        <div style="min-width:200px;max-width:260px">
          <div class="popup-title">${data.name}</div>
          <div class="popup-cat">${data.category}</div>
          <div class="popup-desc">${(data.description||'').substring(0,100)}${(data.description||'').length>100?'...':''}</div>
          <div class="popup-author">üìö ${data.author} ¬∑ ${data.status==='aprovado'?'‚úÖ Aprovado':'‚è≥ Pendente'}</div>
          ${badges.length?`<div class="popup-media-row">${badges.map(b=>`<span class="popup-media-badge">${b}</span>`).join('')}</div>`:''}
          <button class="popup-open-btn" onclick="openModal('${id}')">Ver completo ‚Üí</button>
        </div>`);
      const marker = L.marker([data.lat,data.lng],{icon:createIcon(data.status)});
      marker.options._status=data.status||'pending'; marker.bindPopup(popup);
      function flyAndOpen() {
        setActiveMarker(id); marker.setIcon(createIcon(data.status,true)); marker.closePopup();
        const tll=L.latLng(data.lat,data.lng);
        if (map.getZoom()>=17&&map.getBounds().contains(tll)) { marker.openPopup(); return; }
        map.flyTo(tll,18,{duration:1.2,easeLinearity:0.4});
        map.off('zoomend',onZE);
        function onZE() { map.off('zoomend',onZE); setTimeout(()=>marker.openPopup(),100); }
        map.on('zoomend',onZE);
      }
      marker.on('click',e=>{ L.DomEvent.stopPropagation(e); if(marker.isPopupOpen()){marker.closePopup();return;} flyAndOpen(); });
      marker.on('popupclose',()=>{ marker.setIcon(createIcon(data.status,false)); activeMarkerKey=null; });
      marker.addTo(map); markers[id]=marker; markers[id]._flyAndOpen=flyAndOpen;
    }
    let card=document.getElementById(`card-${id}`);
    if (!card) {
      card=document.createElement('div'); card.id=`card-${id}`; card.className=`point-card ${data.status||'pending'}`;
      card.onclick=()=>{ switchTab('list'); markers[id]?._flyAndOpen?.(); };
      const empty=document.querySelector('#pointsList .empty-state'); if(empty) empty.remove();
      document.getElementById('pointsList').insertBefore(card,document.getElementById('pointsList').firstChild);
    }
    const mb=[];
    if (data.photos?.length) mb.push(`üì∑ ${data.photos.length}`);
    if (data.videos?.length) mb.push(`üé¨ ${data.videos.length}`);
    if (data.audios?.length) mb.push(`üéôÔ∏è ${data.audios.length}`);
    if (data.extraText) mb.push('üìù');
    card.innerHTML=`<div class="point-title">${data.name}</div>
      <div class="point-meta"><span class="category-tag">${data.category}</span><span class="status-tag ${data.status||'pending'}">${data.status==='aprovado'?'Aprovado':'Pendente'}</span><span>¬∑ ${data.author}</span></div>
      ${mb.length?`<div class="point-media-icons">${mb.map(b=>`<span class="media-icon-badge">${b}</span>`).join('')}</div>`:''}`;
    document.getElementById('countBadge').textContent=Object.keys(markers).length;
    updateStats();
  }

  // ===== ALUNOS =====
  window.toggleAddForm = function() {
    const f=document.getElementById('addStudentForm'); f.classList.toggle('open');
    if(f.classList.contains('open')) document.getElementById('sName').focus();
  };

  function renderStudents() {
    const arr=Object.entries(students).sort((a,b)=>{
      const na=parseInt(a[1].num)||999, nb=parseInt(b[1].num)||999;
      return na!==nb ? na-nb : a[1].name.localeCompare(b[1].name);
    });
    const list=document.getElementById('studentList');
    if (!arr.length) { list.innerHTML='<div class="empty-state"><p>Nenhum aluno cadastrado.<br>Clique em "+ Aluno" para come√ßar.</p></div>'; updateStats(); return; }
    list.innerHTML=arr.map(([id,s])=>{
      const pts=Object.values(pointsData).filter(p=>p.author===s.name).length;
      const ini=s.name.split(' ').slice(0,2).map(w=>w[0]).join('').toUpperCase();
      return `<div class="student-card">
        <div class="student-avatar">${ini}</div>
        <div class="student-info">
          <div class="student-name">${s.name}</div>
          <div class="student-sub">${s.num?'N¬∫ '+s.num+' ¬∑ ':''}${s.turma||'Sem turma'}</div>
        </div>
        <span class="student-pts ${pts===0?'zero':''}">${pts} pt${pts!==1?'s':''}</span>
        <button class="student-del" onclick="deleteStudent('${id}')">√ó</button>
      </div>`;
    }).join('');
    renderRanking(); updateStudentSelect(); updateStats();
  }

  function renderRanking() {
    const arr=Object.values(students);
    if (!arr.length) { document.getElementById('rankingSection').style.display='none'; return; }
    document.getElementById('rankingSection').style.display='block';
    const top=arr.map(s=>({name:s.name,pts:Object.values(pointsData).filter(p=>p.author===s.name).length}))
      .sort((a,b)=>b.pts-a.pts).slice(0,8);
    const max=Math.max(...top.map(s=>s.pts),1);
    document.getElementById('rankingList').innerHTML=top.map((s,i)=>`
      <div class="ranking-row">
        <div class="r-pos">${i+1}¬∫</div>
        <div class="r-name">${s.name.split(' ')[0]}</div>
        <div class="r-bar-wrap"><div class="r-bar" style="width:${Math.round(s.pts/max*100)}%"></div></div>
        <div class="r-count">${s.pts}</div>
      </div>`).join('');
  }

  function updateStudentSelect() {
    const sel=document.getElementById('authorSelect'); const cur=sel.value;
    sel.innerHTML='<option value="">Selecionar aluno...</option>';
    Object.values(students).sort((a,b)=>{ const na=parseInt(a.num)||999,nb=parseInt(b.num)||999; return na!==nb?na-nb:a.name.localeCompare(b.name); })
      .forEach(s=>{ const o=document.createElement('option'); o.value=s.name; o.textContent=s.name+(s.turma?' ('+s.turma+')':''); sel.appendChild(o); });
    sel.value=cur;
  }

  function updateStats() {
    const aArr=Object.values(students);
    const pArr=Object.values(pointsData);
    document.getElementById('statAlunos').textContent=aArr.length;
    document.getElementById('statPontos').textContent=pArr.length;
    document.getElementById('statParticip').textContent=aArr.filter(s=>pArr.some(p=>p.author===s.name)).length;
  }

  window.addStudent = async function() {
    const name=document.getElementById('sName').value.trim();
    const turma=document.getElementById('sTurma').value.trim();
    const num=document.getElementById('sNum').value.trim();
    if (!name) { showToast('Informe o nome do aluno.','error'); return; }
    const id='aluno_'+Date.now();
    const sData={name,turma,num,createdAt:new Date().toISOString()};
    students[id]=sData;
    if (!DEMO_MODE) { try { await setDoc(doc(db,'alunos',id),sData); } catch { showToast('Erro ao salvar aluno.','error'); return; } }
    renderStudents();
    document.getElementById('sName').value=''; document.getElementById('sTurma').value=''; document.getElementById('sNum').value='';
    document.getElementById('addStudentForm').classList.remove('open');
    showToast(`‚úÖ ${name} adicionado!`,'success');
  };

  window.deleteStudent = async function(id) {
    if (!confirm('Remover este aluno?')) return;
    delete students[id];
    if (!DEMO_MODE) { try { await deleteDoc(doc(db,'alunos',id)); } catch {} }
    renderStudents(); showToast('Aluno removido.');
  };

  // ===== PDF =====
  window.gerarPDF = function() {
    const arr=Object.values(students).sort((a,b)=>{ const na=parseInt(a.num)||999,nb=parseInt(b.num)||999; return na!==nb?na-nb:a.name.localeCompare(b.name); });
    const pts=Object.values(pointsData);
    const hoje=new Date().toLocaleDateString('pt-BR',{day:'2-digit',month:'long',year:'numeric'});

    const rankTop=arr.map(s=>({name:s.name,pts:pts.filter(p=>p.author===s.name).length}))
      .sort((a,b)=>b.pts-a.pts).filter(s=>s.pts>0).slice(0,5)
      .map((s,i)=>`<tr><td style="padding:7px 14px;font-weight:700;color:#c4933a;font-size:13px">${i+1}¬∫</td><td style="padding:7px 14px;font-weight:500;font-size:13px">${s.name}</td><td style="padding:7px 14px;text-align:center;font-weight:700;color:#b5451b;font-size:13px">${s.pts}</td></tr>`).join('');

    const tableRows=arr.map(s=>{
      const n=pts.filter(p=>p.author===s.name).length;
      const pList=pts.filter(p=>p.author===s.name).map(p=>`<span style="font-size:11px;background:#f5edd6;padding:2px 7px;border-radius:10px;margin:2px;display:inline-block">${p.name}</span>`).join('');
      return `<tr style="border-bottom:1px solid #e8dcc8;">
        <td style="padding:8px 12px;font-size:13px">${s.num||'‚Äî'}</td>
        <td style="padding:8px 12px;font-size:13px;font-weight:500">${s.name}</td>
        <td style="padding:8px 12px;font-size:13px">${s.turma||'‚Äî'}</td>
        <td style="padding:8px 12px;text-align:center;font-weight:700;color:${n>0?'#b5451b':'#bbb'};font-size:13px">${n}</td>
        <td style="padding:8px 12px">${pList||'<span style="color:#bbb;font-size:11px">‚Äî</span>'}</td>
      </tr>`;
    }).join('');

    const html=`<!DOCTYPE html><html><head><meta charset="UTF-8">
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@700;900&family=DM+Sans:wght@300;400;500&display=swap" rel="stylesheet">
    <style>
      body{font-family:'DM Sans',sans-serif;color:#1a1208;padding:40px;max-width:960px;margin:0 auto;}
      h1{font-family:'Playfair Display',serif;font-size:2rem;color:#1a1208;margin-bottom:4px;}
      h2{font-family:'Playfair Display',serif;font-size:1.15rem;color:#b5451b;margin:28px 0 12px;border-bottom:2px solid #f5edd6;padding-bottom:6px;}
      .sub{color:#999;font-size:0.9rem;margin-bottom:30px;}
      .stats{display:flex;gap:16px;margin-bottom:28px;}
      .sbox{background:#f5edd6;border-radius:10px;padding:16px 24px;text-align:center;flex:1;}
      .snum{font-family:'Playfair Display',serif;font-size:2rem;font-weight:700;color:#b5451b;}
      .slbl{font-size:0.72rem;color:#999;text-transform:uppercase;letter-spacing:.06em;}
      table{width:100%;border-collapse:collapse;}
      thead{background:#1a1208;color:#f5edd6;}
      thead th{padding:10px 12px;font-size:12px;text-transform:uppercase;letter-spacing:.05em;font-weight:500;text-align:left;}
      .print-btn{float:right;background:#b5451b;color:white;border:none;padding:10px 20px;border-radius:8px;cursor:pointer;font-family:'DM Sans',sans-serif;font-size:14px;font-weight:500;}
      @media print{.print-btn{display:none}body{padding:20px}}
    </style></head><body>
    <button class="print-btn" onclick="window.print()">üñ®Ô∏è Imprimir / Salvar PDF</button>
    <h1>PK Explorer</h1>
    <p class="sub">Relat√≥rio da Eletiva ¬∑ Gerado em ${hoje}</p>
    <div class="stats">
      <div class="sbox"><div class="snum">${arr.length}</div><div class="slbl">Total de alunos</div></div>
      <div class="sbox"><div class="snum">${pts.length}</div><div class="slbl">Pontos registrados</div></div>
      <div class="sbox"><div class="snum">${arr.filter(s=>pts.some(p=>p.author===s.name)).length}</div><div class="slbl">Participaram</div></div>
      <div class="sbox"><div class="snum">${arr.filter(s=>!pts.some(p=>p.author===s.name)).length}</div><div class="slbl">Sem cadastro</div></div>
    </div>
    ${rankTop?`<h2>üèÜ Ranking ‚Äî Top 5</h2><table><thead><tr><th>Posi√ß√£o</th><th>Aluno</th><th style="text-align:center">Pontos</th></tr></thead><tbody>${rankTop}</tbody></table>`:''}
    <h2>üìã Lista completa de alunos</h2>
    <table>
      <thead><tr><th>N¬∫</th><th>Nome</th><th>Turma</th><th style="text-align:center">Pontos</th><th>Locais cadastrados</th></tr></thead>
      <tbody>${tableRows||'<tr><td colspan="5" style="text-align:center;padding:24px;color:#bbb">Nenhum aluno cadastrado</td></tr>'}</tbody>
    </table>
    </body></html>`;

    const win=window.open('','_blank'); win.document.write(html); win.document.close();
  };

  // ===== TOAST =====
  window.showToast = function(msg,type='') { const t=document.getElementById('toast'); t.textContent=msg; t.className=`toast show ${type}`; setTimeout(()=>t.className='toast',3000); };

  // ===== GPS =====
  window.getGPS = function() {
    if (!navigator.geolocation) { showToast('GPS n√£o dispon√≠vel.','error'); return; }
    const btn=document.querySelector('.gps-btn'); btn.innerHTML='<div class="loading"></div> Obtendo...'; btn.disabled=true;
    navigator.geolocation.getCurrentPosition(pos=>{
      document.getElementById('lat').value=pos.coords.latitude.toFixed(6); document.getElementById('lng').value=pos.coords.longitude.toFixed(6);
      map.flyTo([pos.coords.latitude,pos.coords.longitude],16,{duration:1.2});
      btn.innerHTML=`<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><circle cx="12" cy="12" r="3"/><path d="M12 2v4M12 18v4M2 12h4M18 12h4"/></svg> ‚úì Localiza√ß√£o capturada`; btn.disabled=false; showToast('üìç Localiza√ß√£o capturada!','success');
    }, ()=>{ btn.innerHTML=`<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><circle cx="12" cy="12" r="3"/><path d="M12 2v4M12 18v4M2 12h4M18 12h4"/></svg> Usar minha localiza√ß√£o`; btn.disabled=false; showToast('Erro ao obter GPS.','error'); });
  };

  // ===== UPLOAD M√çDIAS =====
  async function uploadFiles(pointId) {
    const urls={photos:[],videos:[],audios:[]};
    if (DEMO_MODE) { mediaFiles.photo.forEach(f=>urls.photos.push(URL.createObjectURL(f))); mediaFiles.video.forEach(f=>urls.videos.push(URL.createObjectURL(f))); audioBlobs.filter(Boolean).forEach(b=>urls.audios.push(URL.createObjectURL(b))); return urls; }
    const up=async(file,path)=>{ const r=sRef(storage,path); await uploadBytes(r,file); return getDownloadURL(r); };
    for (const [i,f] of mediaFiles.photo.entries()) urls.photos.push(await up(f,`pontos/${pointId}/foto_${i}`));
    for (const [i,f] of mediaFiles.video.entries()) urls.videos.push(await up(f,`pontos/${pointId}/video_${i}`));
    for (const [i,b] of audioBlobs.filter(Boolean).entries()) urls.audios.push(await up(b,`pontos/${pointId}/audio_${i}`));
    return urls;
  }

  // ===== SUBMIT PONTO =====
  window.submitPoint = async function() {
    const author=document.getElementById('authorSelect').value;
    const name=document.getElementById('pointName').value.trim();
    const category=document.getElementById('category').value;
    const description=document.getElementById('description').value.trim();
    const extraText=document.getElementById('extraText').value.trim();
    const lat=parseFloat(document.getElementById('lat').value);
    const lng=parseFloat(document.getElementById('lng').value);
    if (!author) { showToast('Selecione o aluno respons√°vel.','error'); return; }
    if (!name||!category) { showToast('Preencha nome e categoria.','error'); return; }
    if (!lat||!lng) { showToast('Capture a localiza√ß√£o GPS.','error'); return; }
    const btn=document.getElementById('submitBtn'); btn.disabled=true; btn.innerHTML='<div class="loading"></div> Enviando...';
    const pointId='pt_'+Date.now();
    let mediaUrls={photos:[],videos:[],audios:[]};
    try { mediaUrls=await uploadFiles(pointId); } catch { showToast('Erro no upload de m√≠dias.','error'); }
    const pointData={name,author,category,description,extraText,lat,lng,status:'pending',...mediaUrls,createdAt:new Date().toISOString()};
    if (DEMO_MODE) { await new Promise(r=>setTimeout(r,600)); renderPoint(pointId,pointData); showToast('‚úÖ Ponto registrado! (modo demo)','success'); }
    else { try { await addDoc(collection(db,'pontos'),{...pointData,createdAt:serverTimestamp()}); showToast('‚úÖ Ponto registrado e sincronizado!','success'); } catch { showToast('Erro ao salvar no Firestore.','error'); btn.disabled=false; btn.textContent='Registrar Ponto Hist√≥rico'; return; } }
    ['pointName','description','lat','lng','extraText'].forEach(id=>{const el=document.getElementById(id);if(el)el.value='';});
    document.getElementById('category').value=''; document.getElementById('authorSelect').value=''; document.getElementById('mediaPreview').innerHTML=''; document.getElementById('audioList').innerHTML='';
    mediaFiles={photo:[],video:[]}; audioBlobs=[];
    ['photos','videos','audio','texts'].forEach(t=>{ const k=t==='audio'?'mup-audio-panel':'mup-'+t; document.getElementById(k).style.display='none'; document.getElementById('mtb-'+t).classList.remove('active'); }); activeMediaTab=null;
    document.querySelector('.gps-btn').innerHTML=`<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><circle cx="12" cy="12" r="3"/><path d="M12 2v4M12 18v4M2 12h4M18 12h4"/></svg> Usar minha localiza√ß√£o atual`;
    btn.disabled=false; btn.textContent='Registrar Ponto Hist√≥rico'; switchTab('list');
  };

  // ===== FIREBASE LISTENERS =====
  function initListeners() {
    if (DEMO_MODE) { document.getElementById('statusDot').style.background='#e6a817'; document.getElementById('statusLabel').textContent='Modo demo'; return; }
    // Pontos em tempo real
    const qP=query(collection(db,'pontos'),orderBy('createdAt','desc'));
    onSnapshot(qP, snap=>{ document.getElementById('statusDot').style.cssText='background:#4caf50;box-shadow:0 0 8px #4caf50'; document.getElementById('statusLabel').textContent='Tempo real ativo'; snap.docChanges().forEach(c=>{ if(c.type==='added'||c.type==='modified') renderPoint(c.doc.id,c.doc.data()); }); }, ()=>{ document.getElementById('statusDot').style.background='#b5451b'; document.getElementById('statusLabel').textContent='Erro de conex√£o'; });
    // Alunos em tempo real
    onSnapshot(collection(db,'alunos'), snap=>{ snap.docChanges().forEach(c=>{ if(c.type==='added'||c.type==='modified') students[c.doc.id]=c.doc.data(); else if(c.type==='removed') delete students[c.doc.id]; }); renderStudents(); });
  }

  // ===== EVENT DELEGATION ‚Äî substitui todos os onclick inline =====
  document.addEventListener('click', function(e) {
    const el = e.target.closest('[data-action]');
    if (!el) return;
    const action = el.dataset.action;
    const arg = el.dataset.arg;
    const fns = {
      switchTab:        () => switchTab(arg),
      toggleMediaTab:   () => toggleMediaTab(arg),
      startRecording:   () => startRecording(),
      stopRecording:    () => stopRecording(),
      getGPS:           () => getGPS(),
      submitPoint:      () => submitPoint(),
      toggleAddForm:    () => toggleAddForm(),
      addStudent:       () => addStudent(),
      gerarPDF:         () => gerarPDF(),
      closeModalDirect: () => closeModalDirect(),
      triggerPhoto:     () => document.getElementById('photoInput').click(),
      triggerVideo:     () => document.getElementById('videoInput').click(),
    };
    if (fns[action]) { e.preventDefault(); fns[action](); }
  });

  // Modal overlay click to close
  document.getElementById('modalOverlay').addEventListener('click', function(e) {
    if (e.target === this) closeModalDirect();
  });

  // File input changes
  document.getElementById('photoInput').addEventListener('change', e => handleFiles(e, 'photo'));
  document.getElementById('videoInput').addEventListener('change', e => handleFiles(e, 'video'));

  map.on('click',e=>{ document.getElementById('lat').value=e.latlng.lat.toFixed(6); document.getElementById('lng').value=e.latlng.lng.toFixed(6); showToast('üìç Coordenadas definidas pelo clique.'); });

  initListeners();

  // Demo: pontos e alunos de exemplo
  setTimeout(()=>{
    if (document.getElementById('statusLabel').textContent!=='Modo demo') return;
    const dA=[{name:'Ana Lima',turma:'9¬∫A',num:'01'},{name:'Carlos Melo',turma:'9¬∫A',num:'02'},{name:'Beatriz Souza',turma:'9¬∫A',num:'03'},{name:'Diego Ferreira',turma:'9¬∫A',num:'04'},{name:'Elena Costa',turma:'9¬∫A',num:'05'}];
    const dP=[
      {name:'Pra√ßa Central',author:'Ana Lima',category:'Marco Geogr√°fico',description:'Marco zero da cidade, fundado em 1889.',lat:-15.780,lng:-47.929,status:'aprovado',photos:[],videos:[],audios:[],extraText:'Ref: Livro da cidade, cap.3.'},
      {name:'Igreja Matriz S√©c. XIX',author:'Carlos Melo',category:'Religi√£o',description:'Estilo barroco colonial.',lat:-15.783,lng:-47.935,status:'aprovado',photos:[],videos:[],audios:[],extraText:''},
      {name:'Ru√≠nas da Fazenda',author:'Beatriz Souza',category:'Economia',description:'Vest√≠gios do per√≠odo cafeeiro.',lat:-15.775,lng:-47.922,status:'pending',photos:[],videos:[],audios:[],extraText:''},
    ];
    dA.forEach((a,i)=>{ students['demo_a'+i]=a; });
    dP.forEach((p,i)=>setTimeout(()=>renderPoint('demo_p'+i,p),i*200));
    renderStudents();
  },1000);
</script>
</body>
</html>
